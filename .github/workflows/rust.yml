# .github/workflows/rust.yml
#
# Two modes:
# - ci: Runs on push/PR, builds everything, runs tests, creates artifacts
# - deploy: Manual trigger, downloads CI artifacts, deploys to GitHub Pages

name: build

on:
  push:
    branches:
      - 'master'
    tags:
      - '[0-9]+.[0-9]+.[0-9]+*'
  pull_request:

  workflow_dispatch:
    inputs:
      run_mode:
        description: 'Select the workflow to run'
        type: choice
        options:
          - ci
          - deploy
        required: true
        default: 'ci'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # =============================================================================
  # CI Jobs - Run on push, PR, or manual 'ci' mode
  # =============================================================================

  lint_and_check:
    name: Lint & Static Checks
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.run_mode == 'ci'
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.87.0

      - name: Run autofix and normalize
        run: |
          cargo run -r -p azul-doc autofix
          cargo run -r -p azul-doc autofix explain
          cargo run -r -p azul-doc patch safe target/autofix/patches
          cargo run -r -p azul-doc patch target/autofix/patches
          cargo run -r -p azul-doc normalize

      - name: Check for uncommitted changes after autofix
        run: |
          if ! git diff --quiet; then
            echo "There are uncommitted content changes after running autofix:"
            git diff --stat
            git diff
            exit 1
          elif [[ -n $(git status --porcelain) ]]; then
            echo "Files touched but no content changes - resetting:"
            git checkout -- .
            echo "Reset complete, continuing..."
          else
            echo "No uncommitted changes after autofix."
          fi

      - name: Generate DLL API bindings and run tests
        run: |
          cargo run -r -p azul-doc codegen all
          cd dll && cargo test

      - name: Check crates
        run: |
          cargo check -p azul-css
          cargo check -p azul-core
          cargo check -p azul-layout
          cargo check -p azul-dll --no-default-features --features "link-static,logging,ico,tga,hdr,webp,pnm,gif,png,tiff,bmp,a11y"

  test_heavy:
    name: Run Heavy Tests (Miri + Reftests)
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.run_mode == 'ci'
    runs-on: ubuntu-22.04
    needs: lint_and_check
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.87.0

      - name: Install Miri
        run: |
          rustup toolchain install nightly --component miri
          cargo +nightly miri setup

      - name: Run Miri tests
        run: cargo +nightly miri test --lib -p azul-core

      - name: Generate DLL API bindings
        run: cargo run -r -p azul-doc codegen all

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Cache Chrome reference images
        uses: actions/cache@v4
        with:
          path: doc/target/reftest/reftest_img/*_chrome.webp
          key: reftest-chrome-images-${{ hashFiles('doc/working/*.xhtml') }}
          restore-keys: reftest-chrome-images-

      - name: Run reftests
        run: cargo run -r -p azul-doc reftest

      - name: Upload reftest results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: reftest-results
          path: |
            doc/target/reftest/index.html
            doc/target/reftest/results.json
            doc/target/reftest/reftest_img/
          retention-days: 30
          if-no-files-found: warn

  ffi_safety_tests:
    name: FFI Safety Tests (${{ matrix.os }})
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.run_mode == 'ci'
    needs: lint_and_check
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            timeout_cmd: timeout
          - os: macos-14
            timeout_cmd: gtimeout
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.87.0

      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-22.04'
        run: sudo apt-get update && sudo apt-get install -y clang lldb

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-14'
        run: brew install coreutils

      - name: Install Miri
        run: |
          rustup toolchain install nightly --component miri
          cargo +nightly miri setup

      - name: Generate DLL API bindings
        run: cargo run -r -p azul-doc codegen all

      - name: Build azul-dll (debug)
        run: cargo build -p azul-dll --features build-dll

      - name: Compile C hello-world with ASan
        run: |
          cp target/codegen/v2/azul.h examples/c/
          cd examples/c
          clang -g -O0 -fsanitize=address -I. hello-world.c -L../../target/debug -lazul -o hello-world-asan

      - name: Run C hello-world with ASan
        working-directory: examples/c
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/target/debug
          DYLD_LIBRARY_PATH: ${{ github.workspace }}/target/debug
          ASAN_OPTIONS: detect_leaks=0,abort_on_error=1
          AZUL_EXIT_SUCCESS_AFTER_FRAME_RENDER: "1"
        run: ${{ matrix.timeout_cmd }} 30 ./hello-world-asan || [ $? -eq 124 ]

      - name: Run Miri on azul-dll
        run: cargo +nightly miri test --lib -p azul-dll -- --nocapture

  build_binaries:
    name: Build Binaries (${{ matrix.os }})
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.run_mode == 'ci'
    needs: lint_and_check
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            artifact_name: azul-linux-amd64
            artifact_path: |
              target/release/libazul.so
              target/release/libazul.a
              target/release/azul.so
              target/codegen/v2/azul.h
              target/codegen/v2/azul03.hpp
              target/codegen/v2/azul11.hpp
              target/codegen/v2/azul14.hpp
              target/codegen/v2/azul17.hpp
              target/codegen/v2/azul20.hpp
              target/codegen/v2/azul23.hpp
          - os: macos-14
            artifact_name: azul-macos-amd64
            artifact_path: |
              target/release/libazul.dylib
              target/release/libazul.a
              target/release/azul.so
              target/codegen/v2/azul.h
              target/codegen/v2/azul03.hpp
              target/codegen/v2/azul11.hpp
              target/codegen/v2/azul14.hpp
              target/codegen/v2/azul17.hpp
              target/codegen/v2/azul20.hpp
              target/codegen/v2/azul23.hpp
          - os: windows-2022
            artifact_name: azul-windows-amd64
            artifact_path: |
              target/release/azul.dll
              target/release/azul.lib
              target/release/azul.dll.lib
              target/release/azul.pyd
              target/codegen/v2/azul.h
              target/codegen/v2/azul03.hpp
              target/codegen/v2/azul11.hpp
              target/codegen/v2/azul14.hpp
              target/codegen/v2/azul17.hpp
              target/codegen/v2/azul20.hpp
              target/codegen/v2/azul23.hpp
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.87.0

      - name: Install clang (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: sudo apt-get update && sudo apt-get install -y clang

      - name: Install coreutils (macOS)
        if: matrix.os == 'macos-14'
        run: brew install coreutils

      - name: Generate DLL API bindings
        run: cargo run -r -p azul-doc codegen all

      - name: Validate C header syntax (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          cd target/codegen/v2
          clang -fsyntax-only -std=c99 -x c azul.h
          echo "C header (C99) compiles successfully"

      - name: Validate C++ headers (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          cd target/codegen/v2
          clang++ -std=c++03 -fsyntax-only -I. azul03.hpp && echo "C++03 ✓"
          clang++ -std=c++11 -fsyntax-only -I. azul11.hpp && echo "C++11 ✓"
          clang++ -std=c++14 -fsyntax-only -I. azul14.hpp && echo "C++14 ✓"
          clang++ -std=c++17 -fsyntax-only -I. azul17.hpp && echo "C++17 ✓"
          clang++ -std=c++20 -fsyntax-only -I. azul20.hpp && echo "C++20 ✓"
          clang++ -std=c++2b -fsyntax-only -I. azul23.hpp && echo "C++23 ✓"

      - name: Compile C examples (syntax check)
        if: matrix.os != 'windows-2022'
        shell: bash
        run: |
          cd examples/c
          for example in *.c; do
            [ -f "$example" ] && clang -fsyntax-only -std=c99 -I../../target/codegen/v2 "$example" && echo "✓ $example"
          done

      - name: Compile C++ examples (syntax check)
        if: matrix.os != 'windows-2022'
        shell: bash
        run: |
          for std in cpp03:c++03 cpp11:c++11 cpp14:c++14 cpp17:c++17 cpp23:c++2b; do
            dir="${std%:*}"
            flag="${std#*:}"
            if [ -d "examples/cpp/$dir" ]; then
              cd "examples/cpp/$dir"
              for example in *.cpp; do
                [ -f "$example" ] && clang++ -fsyntax-only -std=$flag -I../../../target/codegen/v2 "$example" && echo "✓ $dir/$example"
              done
              cd ../../..
            fi
          done

      - name: Build DLL (for C/C++ examples)
        run: cargo build --release -p azul-dll --features="build-dll"

      - name: Build Rust examples
        run: cargo check --verbose --examples --all-features

      - name: Take screenshots (Linux)
        if: matrix.os == 'ubuntu-22.04'
        continue-on-error: true
        run: |
          chmod +x scripts/screenshot.sh
          xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" ./scripts/screenshot.sh || echo "Screenshots failed"

      - name: Take screenshots (macOS)
        if: matrix.os == 'macos-14'
        continue-on-error: true
        run: |
          chmod +x scripts/screenshot.sh
          ./scripts/screenshot.sh || echo "Screenshots failed"

      - name: Take screenshots (Windows)
        if: matrix.os == 'windows-2022'
        continue-on-error: true
        shell: bash
        run: |
          chmod +x scripts/screenshot.sh
          ./scripts/screenshot.sh || echo "Screenshots failed"

      - name: Build Python extension
        run: cargo build --release -p azul-dll --lib --features="python-extension"

      - name: Rename Python extension (Windows)
        if: matrix.os == 'windows-2022'
        shell: bash
        run: cp target/release/azul.dll target/release/azul.pyd

      - name: Rename Python extension (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: cp target/release/libazul.so target/release/azul.so

      - name: Rename Python extension (macOS)
        if: matrix.os == 'macos-14'
        run: cp target/release/libazul.dylib target/release/azul.so

      - name: Test Python extension import
        shell: bash
        run: |
          if [ "${{ matrix.os }}" = "windows-2022" ]; then
            export PATH=$PATH:$(pwd)/target/release
            python3 -c "import sys; sys.path.insert(0, 'target/release'); import azul; print('Python extension loaded!')"
          else
            cp target/release/azul.so examples/python/
            cd examples/python && python3 -c "import azul; print('Python extension loaded!')"
          fi

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: screenshots-${{ matrix.os }}
          path: target/screenshots/*.png
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_path }}
          retention-days: 30
          if-no-files-found: error

  build_linux_packages:
    name: Build Linux Packages (.deb/.rpm)
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.run_mode == 'ci'
    needs: build_binaries
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Linux binaries
        uses: actions/download-artifact@v4
        with:
          name: azul-linux-amd64
          path: artifacts

      - name: Debug - List artifacts
        run: ls -laR artifacts/

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.87.0

      - name: Install NFPM
        run: |
          echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
          sudo apt-get update
          sudo apt-get install -y nfpm

      - name: Generate NFPM config
        run: cargo run -r -p azul-doc nfpm

      - name: Prepare package files
        run: |
          mkdir -p target/packages
          find artifacts -name "libazul.so" -exec cp {} target/packages/ \;
          find artifacts -name "azul.h" -exec cp {} target/packages/ \;
          cp LICENSE target/packages/
          ls -la target/packages/

      - name: Build .deb and .rpm packages
        run: |
          cd target/packages
          nfpm pkg --packager deb --target .
          nfpm pkg --packager rpm --target .

      - name: Upload .deb package
        uses: actions/upload-artifact@v4
        with:
          name: azul-linux-amd64-deb
          path: target/packages/*.deb
          retention-days: 30
          if-no-files-found: error

      - name: Upload .rpm package
        uses: actions/upload-artifact@v4
        with:
          name: azul-linux-amd64-rpm
          path: target/packages/*.rpm
          retention-days: 30
          if-no-files-found: error

  # =============================================================================
  # Deploy Job - Only runs on manual 'deploy' mode
  # Downloads all artifacts from CI and deploys to GitHub Pages
  # =============================================================================

  build_and_deploy_pages:
    name: Build & Deploy to GitHub Pages
    if: github.event.inputs.run_mode == 'deploy'
    runs-on: ubuntu-22.04
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.87.0

      - name: Download Linux binaries
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: azul-linux-amd64
          path: artifacts-linux

      - name: Download macOS binaries
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: azul-macos-amd64
          path: artifacts-macos

      - name: Download Windows binaries
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: azul-windows-amd64
          path: artifacts-windows

      - name: Download .deb package
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: azul-linux-amd64-deb
          path: artifacts-deb

      - name: Download .rpm package
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: azul-linux-amd64-rpm
          path: artifacts-rpm

      - name: Download reftest results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: reftest-results
          path: doc/target/reftest

      - name: Debug - List all downloaded artifacts
        run: |
          echo "=== Linux ===" && ls -laR artifacts-linux/ 2>/dev/null || echo "Not found"
          echo "=== macOS ===" && ls -laR artifacts-macos/ 2>/dev/null || echo "Not found"
          echo "=== Windows ===" && ls -laR artifacts-windows/ 2>/dev/null || echo "Not found"
          echo "=== DEB ===" && ls -laR artifacts-deb/ 2>/dev/null || echo "Not found"
          echo "=== RPM ===" && ls -laR artifacts-rpm/ 2>/dev/null || echo "Not found"
          echo "=== Reftest ===" && ls -laR doc/target/reftest/ 2>/dev/null || echo "Not found"

      - name: Prepare release artifacts
        run: |
          mkdir -p doc/target/deploy/release/1.0.0-alpha1
          
          # Copy Linux binaries
          find artifacts-linux -name "libazul.so" -exec cp {} doc/target/deploy/release/1.0.0-alpha1/ \; 2>/dev/null || true
          find artifacts-linux -name "libazul.a" -exec cp {} doc/target/deploy/release/1.0.0-alpha1/libazul.linux.a \; 2>/dev/null || true
          find artifacts-linux -name "azul.so" -exec cp {} doc/target/deploy/release/1.0.0-alpha1/azul.cpython.so \; 2>/dev/null || true
          
          # Copy macOS binaries
          find artifacts-macos -name "libazul.dylib" -exec cp {} doc/target/deploy/release/1.0.0-alpha1/ \; 2>/dev/null || true
          find artifacts-macos -name "libazul.a" -exec cp {} doc/target/deploy/release/1.0.0-alpha1/libazul.macos.a \; 2>/dev/null || true
          find artifacts-macos -name "azul.so" -exec cp {} doc/target/deploy/release/1.0.0-alpha1/azul.macos.so \; 2>/dev/null || true
          
          # Copy Windows binaries
          find artifacts-windows -name "azul.dll" ! -name "*.lib" -exec cp {} doc/target/deploy/release/1.0.0-alpha1/ \; 2>/dev/null || true
          find artifacts-windows -name "azul.dll.lib" -exec cp {} doc/target/deploy/release/1.0.0-alpha1/azul.lib \; 2>/dev/null || true
          find artifacts-windows -name "azul.pyd" -exec cp {} doc/target/deploy/release/1.0.0-alpha1/ \; 2>/dev/null || true
          
          # Copy headers (from any platform, they're the same)
          find artifacts-linux artifacts-macos artifacts-windows -name "azul.h" -exec cp {} doc/target/deploy/release/1.0.0-alpha1/ \; 2>/dev/null || true
          find artifacts-linux artifacts-macos artifacts-windows -name "azul03.hpp" -exec cp {} doc/target/deploy/release/1.0.0-alpha1/ \; 2>/dev/null || true
          find artifacts-linux artifacts-macos artifacts-windows -name "azul11.hpp" -exec cp {} doc/target/deploy/release/1.0.0-alpha1/ \; 2>/dev/null || true
          find artifacts-linux artifacts-macos artifacts-windows -name "azul14.hpp" -exec cp {} doc/target/deploy/release/1.0.0-alpha1/ \; 2>/dev/null || true
          find artifacts-linux artifacts-macos artifacts-windows -name "azul17.hpp" -exec cp {} doc/target/deploy/release/1.0.0-alpha1/ \; 2>/dev/null || true
          find artifacts-linux artifacts-macos artifacts-windows -name "azul20.hpp" -exec cp {} doc/target/deploy/release/1.0.0-alpha1/ \; 2>/dev/null || true
          find artifacts-linux artifacts-macos artifacts-windows -name "azul23.hpp" -exec cp {} doc/target/deploy/release/1.0.0-alpha1/ \; 2>/dev/null || true
          
          # Copy packages
          find artifacts-deb -name "*.deb" -exec cp {} doc/target/deploy/release/1.0.0-alpha1/ \; 2>/dev/null || true
          find artifacts-rpm -name "*.rpm" -exec cp {} doc/target/deploy/release/1.0.0-alpha1/ \; 2>/dev/null || true
          
          # LICENSE files
          cp LICENSE doc/target/deploy/release/1.0.0-alpha1/LICENSE-LINUX.txt 2>/dev/null || true
          cp LICENSE doc/target/deploy/release/1.0.0-alpha1/LICENSE-MACOS.txt 2>/dev/null || true
          cp LICENSE doc/target/deploy/release/1.0.0-alpha1/LICENSE-WINDOWS.txt 2>/dev/null || true
          
          echo "=== Prepared release artifacts ==="
          ls -la doc/target/deploy/release/1.0.0-alpha1/

      - name: Generate codegen for website
        run: cargo run -r -p azul-doc codegen all

      - name: Build website
        run: cargo run --manifest-path doc/Cargo.toml --release -- deploy

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'doc/target/deploy'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
