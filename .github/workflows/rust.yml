# .github/workflows/ci-deploy.yml

name: build

on:
  # Run the 'ci' workflow on push and pull request
  push:
    branches:
      - 'master'
    tags:
      - '[0-9]+.[0-9]+.[0-9]+*'
  pull_request:

  # Allow manual runs with a choice of which workflow to execute
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'Select the workflow to run'
        type: choice
        options:
          - ci
          - fast-deploy
          - fast-deploy-with-reftests
          - deploy
          - prod-deploy
        required: true
        default: 'ci'

# Permissions for deploying to GitHub Pages (only needed for 'deploy' mode)
permissions:
  contents: read
  pages: write
  id-token: write

# Concurrency setting to prevent multiple simultaneous deployments to Pages
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # ===================================================================
  # ==                  CI WORKFLOW ('ci' mode)                      ==
  # ===================================================================

  lint_and_check:
    name: Lint & Static Checks
    # Run this job for push, pull_request, or if 'ci' or 'prod-deploy' mode is manually selected
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.run_mode == 'ci' || github.event.inputs.run_mode == 'prod-deploy'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.86.0 # Pinning version for consistency

      - name: Generate DLL API bindings
        run: |
          cargo run -r -p azul-doc memtest dll

      - name: Check crates
        run: |
          cargo check -p azul-css
          cargo check -p azul-core
          cargo check -p azul-layout
          cargo check -p azul-dll --no-default-features --features "desktop,logging,css_parser,all_img_formats,a11y"

      - name: Run autofix and normalize
        run: |
          cargo run -r -p azul-doc autofix
          cargo run -r -p azul-doc autofix explain
          cargo run -r -p azul-doc patch safe target/autofix/patches
          cargo run -r -p azul-doc patch target/autofix/patches
          cargo run -r -p azul-doc normalize

      - name: Check for uncommitted changes after autofix
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "There are uncommitted changes after running autofix:"
            git status --porcelain
            exit 1
          else
            echo "No uncommitted changes after autofix."
          fi

  test_heavy:
    name: Run Heavy Tests
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.run_mode == 'ci' || github.event.inputs.run_mode == 'prod-deploy'
    runs-on: ubuntu-latest
    needs: lint_and_check # Run after linting passes
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.86.0

      - name: Install Miri
        run: |
          rustup toolchain install nightly --component miri
          cargo +nightly miri setup

      - name: Run Miri tests on RefAny
        run: cargo +nightly miri test --lib -p azul-core

      - name: Run memtest
        run: cargo run -r -p azul-doc memtest run

      - name: Cache Chrome reference images
        uses: actions/cache@v4
        with:
          path: doc/target/reftest/reftest_img/*_chrome.webp
          key: reftest-chrome-images-${{ hashFiles('doc/working/*.xhtml') }}
          restore-keys: |
            reftest-chrome-images-

      - name: Run reftest
        run: cargo run -r -p azul-doc reftest

  # ===================================================================
  # ==          FFI SAFETY TESTS (Address Sanitizer + Miri)          ==
  # ===================================================================

  ffi_safety_tests:
    name: FFI Safety Tests (ASan + Miri)
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.run_mode == 'ci' || github.event.inputs.run_mode == 'prod-deploy'
    needs: lint_and_check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.86.0

      - name: Install Miri
        run: |
          rustup toolchain install nightly --component miri
          cargo +nightly miri setup

      - name: Install clang and LLDB
        run: |
          sudo apt-get update
          sudo apt-get install -y clang lldb

      - name: Build azul-dll with c-api feature (debug)
        run: cargo build -p azul-dll --features c-api

      - name: Generate C header
        run: cargo run -r -p azul-doc codegen

      - name: Compile C hello-world with Address Sanitizer
        run: |
          cd examples/c
          clang -g -O0 -fsanitize=address \
            -I../../target/codegen \
            hello-world.c \
            -L../../target/debug -lazul_dll \
            -o hello-world-asan

      - name: Run C hello-world with Address Sanitizer
        run: |
          cd examples/c
          export LD_LIBRARY_PATH=../../target/debug:$LD_LIBRARY_PATH
          export ASAN_OPTIONS=detect_leaks=0,abort_on_error=1
          # Run with timeout to catch hangs, exit 0 if window closes normally
          timeout 5s ./hello-world-asan || [ $? -eq 124 ]

      - name: Run Miri on Rust examples (kitchen_sink)
        run: |
          # Note: Miri cannot run the full GUI app, but can test the setup/teardown logic
          cargo +nightly miri test --lib -p azul-dll -- --nocapture || true

      - name: Check for FFI safety issues in api.json types
        run: |
          # Run autofix which includes FFI safety checks
          cargo run -r -p azul-doc autofix 2>&1 | tee autofix_output.txt
          # Fail if there are FFI safety warnings about missing repr(C)
          if grep -q "FFI safety issues" autofix_output.txt; then
            echo "ERROR: FFI safety issues detected!"
            grep -A 20 "FFI safety issues" autofix_output.txt
            exit 1
          fi

  ffi_safety_tests_macos:
    name: FFI Safety Tests (macOS ASan + LLDB)
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.run_mode == 'ci' || github.event.inputs.run_mode == 'prod-deploy'
    needs: lint_and_check
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.86.0

      - name: Build azul-dll with c-api feature (debug)
        run: cargo build -p azul-dll --features c-api

      - name: Generate C header
        run: cargo run -r -p azul-doc codegen

      - name: Compile C hello-world with Address Sanitizer
        run: |
          cd examples/c
          clang -g -O0 -fsanitize=address \
            -I../../target/codegen \
            hello-world.c \
            -L../../target/debug -lazul_dll \
            -o hello-world-asan

      - name: Run C hello-world with Address Sanitizer
        run: |
          cd examples/c
          export DYLD_LIBRARY_PATH=../../target/debug:$DYLD_LIBRARY_PATH
          export ASAN_OPTIONS=detect_leaks=0,abort_on_error=1
          # Run with timeout, exit 0 if window closes normally or timeout
          gtimeout 5s ./hello-world-asan || [ $? -eq 124 ]
        continue-on-error: true  # macOS may not have gtimeout

      - name: Run LLDB crash detection on C example
        run: |
          cd examples/c
          export DYLD_LIBRARY_PATH=../../target/debug:$DYLD_LIBRARY_PATH
          # Use LLDB to run and detect crashes - exit on first signal
          echo "run" > /tmp/lldb_commands.txt
          echo "bt" >> /tmp/lldb_commands.txt
          echo "quit" >> /tmp/lldb_commands.txt
          # Run LLDB batch mode - will show backtrace on crash
          lldb -b -s /tmp/lldb_commands.txt ./hello-world-asan 2>&1 | tee lldb_output.txt || true
          # Check for crash indicators
          if grep -q "SIGABRT\|SIGSEGV\|AddressSanitizer" lldb_output.txt; then
            echo "ERROR: Crash detected in C example!"
            cat lldb_output.txt
            exit 1
          fi
        continue-on-error: true  # Don't fail CI if LLDB has issues

  build_binaries:
    name: Build Binaries on ${{ matrix.os }}
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.run_mode == 'ci' || github.event.inputs.run_mode == 'prod-deploy'
    needs: lint_and_check # Run after linting passes
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            artifact_name: azul-macos-amd64
            artifact_path: |
              target/release/awb
              target/release/libazul.dylib
              target/release/libazul.a
          - os: windows-latest
            artifact_name: azul-windows-amd64
            artifact_path: |
              target/release/awb.exe
              target/release/azul.dll
              target/release/libazul.a
              target/release/azul.dll.lib
          - os: ubuntu-latest
            artifact_name: azul-linux-amd64
            artifact_path: |
              target/release/awb
              target/release/libazul.so
              target/release/libazul.a

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.80.0

      - name: Install clang (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y clang

      - name: Check azul.h (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: clang api/c/azul.h -ferror-limit=0

      - name: Build DLL and Python extension
        run: |
          cargo build --release -p azul-dll --features="link-dynamic"
          cargo build --release -p azul-dll --features="link-dynamic, python-extension"

      - name: Build Rust examples
        run: cargo check --verbose --examples --all-features

      - name: Build azul-workbench
        run: cargo build --release --bin azulc --manifest-path azulc/Cargo.toml --features="xml, std, font_loading, image_loading, gif, jpeg, png, tiff, bmp, text_layout"

      - name: Test Python example (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          cp target/release/azul.dll target/release/azul.pyd
          export PATH=$PATH:$(pwd)/target/release
          python examples/python/hello-world.py

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_path }}
          retention-days: 7
          if-no-files-found: error

  # ===================================================================
  # ==            FAST DEPLOYMENT ('fast-deploy' mode)               ==
  # ==   Skips builds and reftests - just generates and deploys      ==
  # ===================================================================

  build_pages_fast:
    name: Fast Build Pages
    if: github.event.inputs.run_mode == 'fast-deploy'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build website (docs only, no platform builds)
        run: cargo run --manifest-path doc/Cargo.toml --release -- deploy

      - name: Upload page artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fast-pages-artifact
          path: 'doc/target/deploy'
          if-no-files-found: error

  prepare_pages_fast:
    name: Prepare Pages Artifacts (Fast)
    if: github.event.inputs.run_mode == 'fast-deploy'
    runs-on: ubuntu-latest
    needs: build_pages_fast
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: fast-pages-artifact
          path: merged-artifacts/

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifacts for Pages deployment
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'merged-artifacts'

  deploy_pages_fast:
    name: Deploy to GitHub Pages (Fast)
    if: github.event.inputs.run_mode == 'fast-deploy'
    runs-on: ubuntu-latest
    needs: prepare_pages_fast
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ===================================================================
  # ==      FAST DEPLOYMENT WITH REFTESTS ('fast-deploy-with-reftests')
  # ==   Skips platform builds but includes reftests                 ==
  # ===================================================================

  build_pages_fast_with_reftests:
    name: Fast Build Pages with Reftests
    if: github.event.inputs.run_mode == 'fast-deploy-with-reftests'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Build website with reftests
        run: cargo run --manifest-path doc/Cargo.toml --release -- fast-deploy-with-reftests

      - name: Upload page artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fast-reftests-pages-artifact
          path: 'doc/target/deploy'
          if-no-files-found: error

  prepare_pages_fast_with_reftests:
    name: Prepare Pages Artifacts (Fast with Reftests)
    if: github.event.inputs.run_mode == 'fast-deploy-with-reftests'
    runs-on: ubuntu-latest
    needs: build_pages_fast_with_reftests
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: fast-reftests-pages-artifact
          path: merged-artifacts/

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifacts for Pages deployment
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'merged-artifacts'

  deploy_pages_fast_with_reftests:
    name: Deploy to GitHub Pages (Fast with Reftests)
    if: github.event.inputs.run_mode == 'fast-deploy-with-reftests'
    runs-on: ubuntu-latest
    needs: prepare_pages_fast_with_reftests
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ===================================================================
  # ==               PAGES DEPLOYMENT ('deploy' mode)                ==
  # ==         Tolerant mode - deploys even if builds fail           ==
  # ===================================================================

  build_pages:
    name: Build Pages on ${{ matrix.os }}
    if: github.event.inputs.run_mode == 'deploy'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: macos
          - os: windows-latest
            platform: windows
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Chrome (Linux only)
        if: matrix.os == 'ubuntu-latest'
        uses: browser-actions/setup-chrome@v1

      - name: Run Reftests (Linux only)
        if: matrix.os == 'ubuntu-latest'
        continue-on-error: true
        run: cargo run --manifest-path doc/Cargo.toml --release -- reftest

      - name: Build website for ${{ matrix.platform }}
        id: build_website
        continue-on-error: true
        run: cargo run --manifest-path doc/Cargo.toml --release -- deploy --build=${{ matrix.platform }}

      - name: Create empty deploy directory on failure
        if: steps.build_website.outcome == 'failure'
        run: |
          mkdir -p doc/target/deploy
          echo "Website build failed - placeholder" > doc/target/deploy/BUILD_FAILED.txt

      - name: Upload ${{ matrix.platform }} page artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pages-artifact-${{ matrix.platform }}
          path: 'doc/target/deploy'
          if-no-files-found: warn

  merge_and_prepare_pages:
    name: Merge & Prepare Pages Artifacts
    if: github.event.inputs.run_mode == 'deploy'
    runs-on: ubuntu-latest
    needs: build_pages
    steps:
      - name: Create merged directory
        run: mkdir -p merged-artifacts

      - name: Download all platform artifacts
        uses: actions/download-artifact@v4
        with:
          path: temp-artifacts/
          pattern: pages-artifact-* # Download all artifacts starting with 'pages-artifact-'
          merge-multiple: true # Merge them into a single directory

      - name: Merge artifacts into final directory
        run: |
          echo "Merging downloaded artifacts..."
          cp -r temp-artifacts/* merged-artifacts/
          echo "Merged artifact contents:"
          ls -R merged-artifacts

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload merged artifacts for Pages deployment
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'merged-artifacts'

  deploy_pages:
    name: Deploy to GitHub Pages
    if: github.event.inputs.run_mode == 'deploy'
    runs-on: ubuntu-latest
    needs: merge_and_prepare_pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ===================================================================
  # ==           PROD DEPLOYMENT ('prod-deploy' mode)                ==
  # ==    Strict mode - fails if any test or build fails             ==
  # ===================================================================

  build_pages_prod:
    name: Build Pages (Prod) on ${{ matrix.os }}
    if: github.event.inputs.run_mode == 'prod-deploy'
    needs: [test_heavy, build_binaries]  # Wait for all CI tests to pass
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true  # Stop all builds if one fails
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: macos
          - os: windows-latest
            platform: windows
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Chrome (Linux only)
        if: matrix.os == 'ubuntu-latest'
        uses: browser-actions/setup-chrome@v1

      - name: Run Reftests (Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: cargo run --manifest-path doc/Cargo.toml --release -- reftest

      - name: Build website for ${{ matrix.platform }}
        run: cargo run --manifest-path doc/Cargo.toml --release -- deploy --build=${{ matrix.platform }}

      - name: Upload ${{ matrix.platform }} page artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prod-pages-artifact-${{ matrix.platform }}
          path: 'doc/target/deploy'
          if-no-files-found: error  # Fail if no files generated

  merge_and_prepare_pages_prod:
    name: Merge & Prepare Pages Artifacts (Prod)
    if: github.event.inputs.run_mode == 'prod-deploy'
    runs-on: ubuntu-latest
    needs: build_pages_prod
    steps:
      - name: Create merged directory
        run: mkdir -p merged-artifacts

      - name: Download all platform artifacts
        uses: actions/download-artifact@v4
        with:
          path: temp-artifacts/
          pattern: prod-pages-artifact-*
          merge-multiple: true

      - name: Merge artifacts into final directory
        run: |
          echo "Merging downloaded artifacts..."
          cp -r temp-artifacts/* merged-artifacts/
          echo "Merged artifact contents:"
          ls -R merged-artifacts

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload merged artifacts for Pages deployment
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'merged-artifacts'

  deploy_pages_prod:
    name: Deploy to GitHub Pages (Prod)
    if: github.event.inputs.run_mode == 'prod-deploy'
    runs-on: ubuntu-latest
    needs: merge_and_prepare_pages_prod
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4