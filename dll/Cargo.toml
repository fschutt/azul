[package]
name = "azul-dll"
version = "0.0.7"
authors = ["Felix Schütt <felix.schuett@maps4print.com>"]
license = "MPL-2.0"
description = "C-API of Azul GUI"
homepage = "https://azul.rs/"
keywords = ["gui", "user-interface", "svg", "graphics", "css" ]
categories = ["gui"]
repository = "https://github.com/maps4print/azul"
edition = "2021"
autoexamples = false
build = "build.rs"

[lib]
name = "azul"
crate-type = ["cdylib", "staticlib", "rlib"]

[dependencies]
# Core crates - only needed for build-dll and link-static, NOT for link-dynamic
azul-core = { path = "../core", version = "0.0.7", default-features = false, optional = true }
azul-css = { path = "../css", version = "0.0.7", default-features = false, optional = true }
azul-layout = { path = "../layout", version = "0.0.7", default-features = false, features = ["font_loading", "text_layout", "svg", "xml"], optional = true }

# Logging
log = { version = "0.4.17", default-features = false, optional = true }
fern = { version = "0.7.1", default-features = false, optional = true }
backtrace = { version = "0.3.66", optional = true }

# Python bindings
pyo3 = { version = "0.27.1", default-features = false, features = ["abi3", "multiple-pymethods", "extension-module", "macros", "auto-initialize"], optional = true }
pyo3-log = { version = "0.13.2", default-features = false, optional = true }

# Desktop windowing dependencies
tfd = { version = "0.1.0", default-features = false, optional = true }
rust-fontconfig = { version = "2.0.0", default-features = false, features = ["std", "parsing", "async-registry", "cache"], optional = true }
gl-context-loader = { version ="0.1.8", default-features = false, optional = true }
webrender = { path = "../webrender/core", default-features = false, optional = true }
once_cell = { version = "1.17.1", optional = true }
bitflags = { version = "2.8.0", optional = true }
serde = { version = "1.0", features = ["derive"], optional = true }
serde_json = { version = "1.0", optional = true }

# Accessibility
accesskit = { version = "0.21.1", default-features = false, optional = true }

# PNG encoding for screenshots
tiny-skia = { version = "0.11.4", default-features = false, features = ["std", "png-format"], optional = true }

# Windows-only: libm for math functions
libm = { version = "0.2.2", default-features = false, optional = true }

# Enum iteration for debug server
strum = { version = "0.26", default-features = false, optional = true }

# SPMC channel for debug server → window timer communication
spmc = { version = "0.3", optional = true }

# Always required
cfg-if = "1.0"

[target.'cfg(target_os = "linux")'.dependencies]
libc = "0.2"
x11-clipboard = { version = "0.9.3", optional = true }
accesskit_unix = { version = "0.17.2", optional = true }

[target.'cfg(any(target_os = "ios"))'.dependencies]
objc = "0.2"
objc-foundation = "0.1"
objc_id = "0.1"

[target.'cfg(target_os = "windows")'.dependencies]
winapi = { version = "0.3.9", default-features = false, features = [
    "windowsx", 
    "libloaderapi", 
    "errhandlingapi", 
    "winuser", 
    "uxtheme", 
    "dwmapi", 
    "wingdi", 
    "commdlg"
] }
clipboard-win = { version = "5.4", optional = true }
accesskit_windows = { version = "0.29.2", optional = true }

[target.'cfg(target_os = "macos")'.dependencies]
cgl = "0.3.2"
dispatch2 = { version = "0.3.0", default-features = false, features = ["std", "objc2"] }
objc2 = "0.6.0"
objc = "0.2"
objc-foundation = "0.1"
objc_id = "0.1"
block2 = "0.6.0"
libloading = "0.8.6"
accesskit_macos = { version = "0.22.2", optional = true }
objc2-core-foundation = { version = "0.3.0", default-features = true, features = [
    "std",
    "CFBase",
    "CFString",
    "CFBundle",
] }
objc2-foundation = { version = "0.3.0", default-features = true, features = [
    "std",
    "NSArray",
    "NSThread",
] }
objc2-app-kit = { version = "0.3.0", default-features = true, features = [
    "std",
    "objc2-core-foundation",
    "NSApplication",
    "NSResponder",
    "NSView",
    "NSWindow",
    "NSOpenGL",
    "NSOpenGLView",
] }

# =============================================================================
# Features
# =============================================================================

[features]
# Default: Build with static linking (for Rust applications)
# Use --features "build-dll" when building the shared library itself
default = [
    "std",
    "link-static",
    "logging",
    "a11y",
    "all_img_formats",
]

# -----------------------------------------------------------------------------
# Build Modes
# -----------------------------------------------------------------------------

# Build the full desktop DLL with windowing, OpenGL, fonts, etc.
# This compiles all the platform-specific code in src/desktop/
build-dll = [
    "std",
    "azul-core",
    "azul-css",
    "azul-layout",
    "tfd",
    "rust-fontconfig",
    "gl-context-loader",
    "webrender",
    "once_cell",
    "bitflags",
    "serde",
    "serde_json",
    "serde-json",
    "backtrace",
    "font_loading",
    "text_layout",
    "svg",
    "xml",
    "strum",
    "spmc",
    "tiny-skia",
    # Platform-specific clipboard
    "x11-clipboard",
    "clipboard-win",
    # Windows needs libm
    "libm",
    # ICU: Foundation backend on macOS (icu_macos), ICU4X on Linux/Windows (icu).
    # Both are listed; the cfg conditions in layout/src/icu.rs ensure only one
    # backend is compiled per platform.
    "icu",
    "icu_macos",
    # Fluent localization support
    "fluent",
    # HTTP client support
    "http",
    # ZIP file manipulation
    "zip_support",
    # JSON support
    "json",
    # Icon provider support
    "icons",
]

# -----------------------------------------------------------------------------
# Link Modes (for consumers of the library)
# -----------------------------------------------------------------------------

# Static linking: Include transmute-based implementations
# Uses: target/codegen/v2/dll_api_static.rs
# Requires the full azul stack to be compiled in
link-static = [
    "std",
    "azul-core",
    "azul-css",
    "azul-layout",
    "tfd",
    "rust-fontconfig",
    "gl-context-loader",
    "webrender",
    "once_cell",
    "bitflags",
    "serde",
    "serde_json",
    "serde-json",
    "backtrace",
    "font_loading",
    "text_layout",
    "svg",
    "xml",
    "strum",
    "spmc",
    "tiny-skia",
    # Platform-specific clipboard
    "x11-clipboard",
    "clipboard-win",
    # Windows needs libm
    "libm",
]

# Dynamic linking: Include extern "C" declarations
# Uses: target/codegen/v2/dll_api_dynamic.rs
# Requires libazul.dylib/so/dll to be available at runtime
# Set AZUL_LINK_PATH environment variable to the directory containing libazul
# NOTE: Does NOT require azul-core or other internal crates
link-dynamic = []

# -----------------------------------------------------------------------------
# Core Features
# -----------------------------------------------------------------------------

# NOTE: std feature only affects azul-core/layout when they are enabled via build-dll or link-static
# For link-dynamic, std has no effect since those crates aren't included
std = ["azul-core?/std", "azul-layout?/std"]
logging = ["log"]

# -----------------------------------------------------------------------------
# Accessibility
# -----------------------------------------------------------------------------

a11y = [
    "accesskit",
    "azul-layout/a11y",
    "accesskit_windows",
    "accesskit_macos",
    "accesskit_unix",
]

# -----------------------------------------------------------------------------
# Image Formats
# -----------------------------------------------------------------------------

all_img_formats = ["ico", "tga", "hdr", "jpeg", "webp", "pnm", "gif", "png", "tiff", "bmp"]
gif = ["azul-layout", "azul-layout/gif"]
jpeg = ["azul-layout", "azul-layout/jpeg"]
png = ["azul-layout", "azul-layout/png"]
tiff = ["azul-layout", "azul-layout/tiff"]
bmp = ["azul-layout", "azul-layout/bmp"]
ico = ["azul-layout", "azul-layout/ico"]
tga = ["azul-layout", "azul-layout/tga"]
hdr = ["azul-layout", "azul-layout/hdr"]
webp = ["azul-layout", "azul-layout/webp"]
pnm = ["azul-layout", "azul-layout/pnm"]

# -----------------------------------------------------------------------------
# Layout Features
# -----------------------------------------------------------------------------

svg = ["azul-layout", "azul-layout/svg"]
xml = ["azul-layout", "azul-layout/xml"]
font_loading = ["azul-layout", "azul-layout/font_loading"]
font_loading_multithreaded = ["font_loading", "azul-layout/font_loading_multithreaded"]
text_layout = ["azul-layout", "azul-layout/text_layout"]

# ICU4X internationalization support
icu = ["azul-layout", "azul-layout/icu"]
icu_chrono = ["icu", "azul-layout/icu_chrono"]

# macOS Foundation ICU backend (replaces ICU4X data blobs on macOS, ~3.3 MB savings).
# On non-macOS platforms this feature is a no-op.
icu_macos = ["azul-layout", "azul-layout/icu_macos"]

# Project Fluent localization support (FTL files, language packs)
fluent = ["azul-layout", "azul-layout/fluent"]

# Icon provider support (material icons, icon packs)
icons = ["azul-layout", "azul-layout/icons"]

# HTTP client support for downloading resources
http = ["azul-layout", "azul-layout/http"]

# ZIP file manipulation support
zip_support = ["azul-layout", "azul-layout/zip_support"]

# JSON parsing and manipulation
json = ["azul-layout", "azul-layout/json"]

# JSON serialization for RefAny (enables RefAny::new_serde<T>)
# Requires T: serde::Serialize + serde::de::DeserializeOwned
serde-json = ["serde", "serde_json", "azul-core?/serde-json"]

# -----------------------------------------------------------------------------
# Logging Backends
# -----------------------------------------------------------------------------

use_fern_logger = ["logging", "fern"]
use_pyo3_logger = ["pyo3-log", "logging"]

# -----------------------------------------------------------------------------
# Predefined Configurations
# -----------------------------------------------------------------------------

# Python extension module
python-extension = ["build-dll", "pyo3", "use_pyo3_logger", "link-static"]

# -----------------------------------------------------------------------------
# Package Metadata
# -----------------------------------------------------------------------------

[package.metadata.deb]
maintainer = "Felix Schütt <felix.schuett@maps4print.com>"
extended-description = """
    AZUL GUI Toolkit (https://azul.rs).
    Cross-platform GUI toolkit written in Rust
    built using the WebRender rendering engine
"""
depends = "$auto"
section = "utility"
priority = "optional"
assets = [
    ["target/release/libazul.so", "usr/lib/", "755"]
]

[package.metadata.docs.rs]
no-default-features = true
features = [
    "std",
    "logging",
    "all_img_formats",
    "font_loading",
    "text_layout",
    "svg",
    "xml",
    "use_fern_logger",
]
