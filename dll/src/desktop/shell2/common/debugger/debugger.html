<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azul Debugger</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="./debugger.css">
</head>
<body>

    <!-- Menu Bar -->
    <div class="menubar" id="menubar">
        <div class="menu-item" data-menu="import">
            Import
            <div class="menu-dropdown">
                <div class="menu-dropdown-item" onclick="app.handlers.importProject()">
                    <span class="material-icons mi">folder_open</span>
                    Project from JSON...
                </div>
                <div class="menu-dropdown-separator"></div>
                <div class="menu-dropdown-item" onclick="app.handlers.importE2eTests()">
                    <span class="material-icons mi">note_add</span>
                    E2E Tests (append)...
                </div>
                <div class="menu-dropdown-separator"></div>
                <div class="menu-dropdown-item" onclick="app.handlers.importComponentLibrary()">
                    <span class="material-icons mi">extension</span>
                    Component Library...
                </div>
            </div>
        </div>
        <div class="menu-item" data-menu="export">
            Export
            <div class="menu-dropdown">
                <div class="menu-dropdown-item" onclick="app.handlers.exportProject()">
                    <span class="material-icons mi">save</span>
                    Project as JSON
                </div>
                <div class="menu-dropdown-separator"></div>
                <div class="menu-dropdown-item" onclick="app.handlers.exportE2eTests()">
                    <span class="material-icons mi">save_alt</span>
                    E2E Tests (CLI format)
                </div>
                <div class="menu-dropdown-separator"></div>
                <div class="menu-dropdown-item" onclick="app.handlers.exportComponentLibrary()">
                    <span class="material-icons mi">extension</span>
                    Component Library (JSON)
                </div>
                <div class="menu-dropdown-separator"></div>
                <div class="menu-dropdown-item" onclick="app.handlers.exportCode('rust')">
                    <span class="material-icons mi">code</span>
                    Code (Rust)
                </div>
                <div class="menu-dropdown-item" onclick="app.handlers.exportCode('c')">
                    <span class="material-icons mi">code</span>
                    Code (C)
                </div>
                <div class="menu-dropdown-item" onclick="app.handlers.exportCode('cpp')">
                    <span class="material-icons mi">code</span>
                    Code (C++)
                </div>
                <div class="menu-dropdown-item" onclick="app.handlers.exportCode('python')">
                    <span class="material-icons mi">code</span>
                    Code (Python)
                </div>
            </div>
        </div>
        <div style="flex:1"></div>
        <div id="connection-status" style="padding:4px 8px; color: var(--warning); cursor:default; font-size:12px;">Disconnected</div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="file-import-project" class="hidden" accept=".json" onchange="app.handlers.handleProjectImport(this)">
    <input type="file" id="file-import-e2e" class="hidden" accept=".json" onchange="app.handlers.handleE2eImport(this)">
    <input type="file" id="file-import-component-lib" class="hidden" accept=".json" onchange="app.handlers.handleComponentLibraryImport(this)">

    <!-- Main Workbench -->
    <div class="workbench">

        <!-- Activity Bar -->
        <div class="activity-bar">
            <div class="activity-icon active" data-view="inspector" onclick="app.ui.switchView('inspector')" title="DOM Inspector">
                <span class="material-icons">account_tree</span>
            </div>
            <div class="activity-icon" data-view="testing" onclick="app.ui.switchView('testing')" title="E2E Testing">
                <span class="material-icons">bug_report</span>
            </div>
            <div class="activity-icon" data-view="components" onclick="app.ui.switchView('components')" title="Component Registry">
                <span class="material-icons">widgets</span>
            </div>
        </div>

        <!-- App State Panel (always visible) -->
        <div class="panel-col" id="appstate-panel" style="width:220px">
            <div class="sidebar-header">
                <span>App State</span>
                <div style="display:flex;gap:4px;align-items:center">
                    <span class="material-icons clickable" style="font-size:16px" onclick="app.handlers.loadAppState()" title="Refresh">refresh</span>
                    <span class="material-icons clickable" style="font-size:16px" onclick="app.handlers._saveSnapshot()" title="Save Snapshot">photo_camera</span>
                </div>
            </div>
            <div id="app-state-tree" class="sidebar-content" style="padding:0;">
                <div class="placeholder-text">Click refresh to load.</div>
            </div>
            <div id="snapshots-container" style="padding:0;"></div>
            <!-- Dataset Panel (visible when selected node has a dataset) -->
            <div id="dataset-panel" style="display:none;">
                <div class="sidebar-header" style="border-top:1px solid var(--border)">
                    <span>Node Dataset</span>
                    <span class="material-icons clickable" style="font-size:16px" onclick="app.handlers.loadNodeDataset()" title="Refresh">refresh</span>
                </div>
                <div id="dataset-tree" class="sidebar-content" style="padding:0;">
                    <div class="placeholder-text">No dataset.</div>
                </div>
            </div>
        </div>
        <div class="resizer" data-target="appstate-panel" data-min="120" data-max="500"></div>

        <!-- Sidebar (DOM Tree / Tests / Components) -->
        <div class="panel-col sidebar" id="sidebar-panel" style="width:280px">
            <div class="sidebar-header">
                <span id="sidebar-title">DOM Explorer</span>
                <span class="material-icons clickable" style="font-size:16px" onclick="app.handlers.refreshSidebar()" title="Refresh">refresh</span>
            </div>

            <div id="sidebar-inspector" class="sidebar-content">
                <div id="dom-tree-container" class="dom-tree">
                    <div class="placeholder-text">Loading DOM tree...</div>
                </div>
            </div>

            <div id="sidebar-testing" class="sidebar-content hidden">
                <div class="btn-row" style="padding:6px 10px;">
                    <button class="btn-sm" onclick="app.handlers.newTest()">+ New Test</button>
                </div>
                <div id="test-list-container"></div>
                <div id="run-status" class="hidden" style="padding:10px; text-align:center; color:var(--text-muted)">
                    <span class="spinner"></span> Running...
                </div>
            </div>

            <div id="sidebar-components" class="sidebar-content hidden">
                <div style="padding:8px;">
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">
                        <label style="font-size:11px;color:var(--text-muted);white-space:nowrap;">Library:</label>
                        <select id="library-selector" onchange="app.handlers.onLibraryChange(this.value)" style="flex:1;background:var(--bg-darker);color:var(--text);border:1px solid var(--border);border-radius:3px;padding:2px 4px;font-size:12px;">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div id="library-buttons" style="display:flex;gap:4px;margin-bottom:6px;">
                        <button class="btn-sm" onclick="app.handlers.createLibrary()" title="Create new library">+ Library</button>
                        <button class="btn-sm" onclick="app.handlers.createComponent()" title="Create new component">+ Component</button>
                    </div>
                    <input type="text" id="component-filter" placeholder="Filter components..." oninput="app.handlers.filterComponents(this.value)"
                        style="width:100%;box-sizing:border-box;background:var(--bg-darker);color:var(--text);border:1px solid var(--border);border-radius:3px;padding:4px 6px;font-size:12px;margin-bottom:4px;">
                </div>
                <div id="component-list-container" style="padding:0 8px 8px 8px;">
                    <div class="placeholder-text">Select a library above.</div>
                </div>
            </div>
        </div>
        <div class="resizer" data-target="sidebar-panel" data-min="180" data-max="500"></div>

        <!-- Main Editor -->
        <div class="editor-group" id="editor-group">
            <div class="editor-tabs">
                <div class="tab">
                    <span class="material-icons" style="font-size:14px; color:var(--accent)">description</span>
                    <span id="tab-title">Inspector</span>
                </div>
            </div>

            <div class="editor-content">
                <div id="view-inspector" style="height:100%; display:flex; flex-direction:column; overflow:hidden;">
                    <div id="node-detail-panel" style="flex:1; overflow:auto; padding:15px;">
                        <div class="placeholder-text">Select a node in the DOM Explorer to inspect it.</div>
                    </div>
                </div>

                <div id="view-testing" class="hidden" style="height:100%; display:flex; flex-direction:column;">
                    <!-- Toolbar (left-aligned, below tab) -->
                    <div class="test-toolbar">
                        <button class="icon-btn success" title="Run" onclick="app.runner.run()"><span class="material-icons">play_arrow</span></button>
                        <button class="icon-btn" title="Pause" onclick="app.runner.pause()"><span class="material-icons">pause</span></button>
                        <button class="icon-btn" title="Step Over" onclick="app.runner.step()"><span class="material-icons">redo</span></button>
                        <button class="icon-btn danger" title="Reset" onclick="app.runner.reset()"><span class="material-icons">stop</span></button>
                        <div class="toolbar-sep"></div>
                        <button class="icon-btn" title="Run headless" onclick="app.runner.runServerSide()"><span class="material-icons">cloud_upload</span></button>
                        <button class="icon-btn" title="Run all headless" onclick="app.runner.runAllServerSide()"><span class="material-icons">cloud_done</span></button>
                        <div class="toolbar-sep"></div>
                        <button class="icon-btn" title="Add Step" onclick="app.ui.showAddStepInline()"><span class="material-icons">add</span></button>
                    </div>
                    <div style="display:flex; flex:1; overflow:hidden;">
                        <div id="steps-container" class="step-list" style="flex:1; overflow:auto;">
                            <div class="placeholder-text">No test selected.</div>
                        </div>
                        <div id="details-content" style="width:280px; overflow:auto; padding:10px; border-left:1px solid var(--border);">
                            <div class="placeholder-text">Select a step to see details.</div>
                        </div>
                    </div>
                </div>

                <div id="view-components" class="hidden" style="height:100%; overflow:hidden; display:flex;">
                    <div id="component-detail-left" style="flex:1; overflow:auto; padding:15px; min-width:0;">
                        <div class="placeholder-text">Select a component from the sidebar to see its details.</div>
                    </div>
                    <div id="component-detail-right" style="width:320px; overflow:auto; padding:15px; border-left:1px solid var(--border); display:none;">
                    </div>
                </div>
            </div>

            <!-- Bottom Panel -->
            <div class="bottom-panel" id="bottom-panel">
                <div class="resizer-h" data-target="bottom-panel" data-min="80" data-max="500"></div>
                <div class="panel-tabs">
                    <div class="panel-tab active" data-panel="terminal" onclick="app.ui.switchPanel('terminal')">Terminal</div>
                    <div class="panel-tab" data-panel="debug" onclick="app.ui.switchPanel('debug')">Debug Console</div>
                </div>
                <div id="panel-terminal" class="terminal-output"></div>
                <div id="panel-debug" class="terminal-output hidden"></div>
                <div class="terminal-input-row">
                    <span style="color:var(--accent); margin-right:5px;">&gt;</span>
                    <input type="text" id="terminal-cmd" class="terminal-input" placeholder='/get_state  or  {"op": "get_state"}'
                        oninput="app.handlers.terminalInput(this)"
                        onkeydown="if(event.key==='Enter') app.handlers.terminalEnter(this); if(event.key==='Escape') app._hideAutocomplete();"
                        onfocus="if(this.value.startsWith('/')) app.handlers.terminalInput(this)"
                        onblur="setTimeout(()=>app._hideAutocomplete(), 150)">
                </div>
            </div>
        </div>

    </div>

    <!-- Context Menu -->
    <div id="context-menu" class="context-menu hidden">
        <div class="context-menu-item" onclick="app.handlers.ctxInsertChild('div')">Insert child div</div>
        <div class="context-menu-item" onclick="app.handlers.ctxInsertChild('span')">Insert child span</div>
        <div class="context-menu-item" onclick="app.handlers.ctxInsertChild('p')">Insert child p</div>
        <div class="context-menu-item" onclick="app.handlers.ctxInsertChild('button')">Insert child button</div>
        <div class="context-menu-item" onclick="app.handlers.ctxInsertChild('text')">Insert child (text)</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="app.handlers.ctxDeleteNode()">Delete node</div>
    </div>

    <!-- Screenshot Modal -->
    <div id="screenshot-modal" class="modal" onclick="this.classList.remove('active')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span>Screenshot</span>
                <span class="material-icons clickable" onclick="document.getElementById('screenshot-modal').classList.remove('active')">close</span>
            </div>
            <div class="modal-body" style="text-align:center; overflow:auto;">
                <img id="screenshot-modal-img" style="max-width:100%;" />
            </div>
        </div>
    </div>
</body>

<script src="./debugger.js" type="application/javascript"></script>
</html>
