<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azul Debug Server</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --bg-tertiary: #2d2d30;
            --bg-hover: #37373d;
            --border-color: #3e3e42;
            --text-primary: #cccccc;
            --text-secondary: #858585;
            --accent: #007acc;
            --accent-hover: #005a9e;
            --success: #4ec9b0;
            --error: #f48771;
            --warning: #ce9178;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Menu Bar */
        .menu-bar {
            height: 35px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 5px;
            flex-shrink: 0;
        }

        .menu-item {
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 13px;
            position: relative;
        }

        .menu-item:hover {
            background: var(--bg-hover);
        }

        .menu-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            min-width: 200px;
            z-index: 1000;
            margin-top: 2px;
        }

        .menu-item:hover .menu-dropdown {
            display: block;
        }

        .menu-dropdown-item {
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-dropdown-item:hover {
            background: var(--bg-hover);
        }

        /* Main Layout */
        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Activity Bar */
        .activity-bar {
            width: 48px;
            background: var(--bg-tertiary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .activity-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            border-left: 2px solid transparent;
        }

        .activity-icon:hover {
            color: var(--text-primary);
        }

        .activity-icon.active {
            color: var(--text-primary);
            border-left-color: var(--accent);
        }

        .activity-icon .material-icons {
            font-size: 24px;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* Tree View */
        .tree-view {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre;
            line-height: 1.5;
        }

        .tree-node {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 2px;
        }

        .tree-node:hover {
            background: var(--bg-hover);
        }

        .tree-node.selected {
            background: var(--accent);
        }

        /* Properties Panel */
        .properties-panel {
            width: 350px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .properties-header {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
            font-weight: 600;
        }

        .properties-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .property-group {
            margin-bottom: 20px;
        }

        .property-group-title {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .property-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .property-key {
            color: var(--text-secondary);
        }

        .property-value {
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
        }

        /* Terminal */
        .terminal {
            height: 200px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .terminal-header {
            padding: 8px 15px;
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .terminal-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .terminal-output {
            margin-bottom: 10px;
        }

        .terminal-input-line {
            display: flex;
            gap: 5px;
        }

        .terminal-prompt {
            color: var(--success);
        }

        .terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 12px;
            outline: none;
        }

        /* E2E Test View */
        .test-list {
            list-style: none;
        }

        .test-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 13px;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .test-item:hover {
            background: var(--bg-hover);
        }

        .test-item.selected {
            background: var(--accent);
        }

        .test-step {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 3px;
            border-left: 3px solid transparent;
        }

        .test-step.breakpoint {
            border-left-color: var(--error);
        }

        .test-step-breakpoint {
            width: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .test-step-breakpoint:hover {
            color: var(--error);
        }

        .test-step-content {
            flex: 1;
        }

        .test-step-input {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .test-step-response {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: 8px;
            border-radius: 3px;
            margin-top: 5px;
            max-height: 100px;
            overflow-y: auto;
        }

        .test-step-actions {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .test-controls {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        /* Buttons */
        .btn {
            padding: 6px 12px;
            background: var(--accent);
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 11px;
        }

        .btn .material-icons {
            font-size: 16px;
        }

        /* JSON Editor */
        .json-editor {
            width: 100%;
            min-height: 100px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            padding: 10px;
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 5px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 14px;
            font-weight: 600;
        }

        .modal-close {
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Form */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            color: var(--text-primary);
            font-size: 13px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-color);
        }

        /* Status indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-success {
            background: var(--success);
        }

        .status-error {
            background: var(--error);
        }

        .status-pending {
            background: var(--warning);
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Menu Bar -->
        <div class="menu-bar">
            <div class="menu-item">
                File
                <div class="menu-dropdown">
                    <div class="menu-dropdown-item" onclick="app.newTest()">
                        <span class="material-icons" style="font-size: 18px;">add</span>
                        New Test
                    </div>
                    <div class="menu-dropdown-item" onclick="app.openImportModal()">
                        <span class="material-icons" style="font-size: 18px;">upload_file</span>
                        Import Test...
                    </div>
                </div>
            </div>
            <div class="menu-item">
                Import
                <div class="menu-dropdown">
                    <div class="menu-dropdown-item" onclick="app.importUI()">
                        <span class="material-icons" style="font-size: 18px;">code</span>
                        UI from HTML
                    </div>
                    <div class="menu-dropdown-item" onclick="app.openImportModal()">
                        <span class="material-icons" style="font-size: 18px;">note_add</span>
                        E2E Test(s)
                    </div>
                </div>
            </div>
            <div class="menu-item">
                Export
                <div class="menu-dropdown">
                    <div class="menu-dropdown-item" onclick="app.exportWorkspace()">
                        <span class="material-icons" style="font-size: 18px;">save</span>
                        Workspace as JSON
                    </div>
                    <div class="menu-dropdown-item" onclick="app.exportTests()">
                        <span class="material-icons" style="font-size: 18px;">save_alt</span>
                        E2E Test(s)
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Activity Bar -->
            <div class="activity-bar">
                <div class="activity-icon active" data-view="inspector" onclick="app.switchView('inspector')">
                    <span class="material-icons">account_tree</span>
                </div>
                <div class="activity-icon" data-view="e2e" onclick="app.switchView('e2e')">
                    <span class="material-icons">bug_report</span>
                </div>
            </div>

            <!-- Inspector View -->
            <div id="inspector-view" class="view">
                <div class="sidebar">
                    <div class="sidebar-header">DOM Tree</div>
                    <div class="sidebar-content">
                        <div id="dom-tree" class="tree-view">Loading...</div>
                    </div>
                </div>

                <div class="main-content">
                    <div class="content-area">
                        <h2 style="margin-bottom: 20px;">UI Inspector</h2>
                        <div id="html-content"></div>
                    </div>

                    <div class="terminal">
                        <div class="terminal-header">
                            <span class="material-icons" style="font-size: 16px;">terminal</span>
                            Terminal
                        </div>
                        <div class="terminal-content" id="terminal-output">
                            <div class="terminal-output">Azul Debug Server Terminal. Type JSON commands to POST to the server.</div>
                            <div class="terminal-input-line">
                                <span class="terminal-prompt">></span>
                                <input type="text" class="terminal-input" id="terminal-input" 
                                       placeholder='{"op": "get_state"}'>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="properties-panel">
                    <div class="properties-header">Properties</div>
                    <div class="properties-content" id="properties-content">
                        <p style="color: var(--text-secondary); font-size: 12px;">
                            Select a node in the HTML to show properties
                        </p>
                    </div>
                </div>
            </div>

            <!-- E2E Testing View -->
            <div id="e2e-view" class="view hidden">
                <div class="sidebar">
                    <div class="sidebar-header">Test Suites</div>
                    <div class="sidebar-content">
                        <ul class="test-list" id="test-list">
                            <li class="test-item selected" onclick="app.selectTest(0)">
                                <span class="material-icons" style="font-size: 18px;">description</span>
                                Default Test
                            </li>
                        </ul>
                        <button class="btn btn-secondary" style="margin-top: 10px; width: 100%;" onclick="app.newTest()">
                            <span class="material-icons">add</span>
                            New Test
                        </button>
                    </div>
                </div>

                <div class="main-content">
                    <div class="test-controls">
                        <button class="btn" onclick="app.runTest()">
                            <span class="material-icons">play_arrow</span>
                            Run
                        </button>
                        <button class="btn btn-secondary" onclick="app.runToBreakpoint()">
                            <span class="material-icons">skip_next</span>
                            Run to Breakpoint
                        </button>
                        <button class="btn btn-secondary" onclick="app.stepTest()">
                            <span class="material-icons">redo</span>
                            Step
                        </button>
                        <button class="btn btn-secondary" onclick="app.stopTest()">
                            <span class="material-icons">stop</span>
                            Stop
                        </button>
                    </div>

                    <div class="content-area" id="test-steps">
                        <!-- Test steps will be added here -->
                    </div>
                </div>

                <div class="properties-panel">
                    <div class="properties-header">Step Details</div>
                    <div class="properties-content" id="step-details">
                        <p style="color: var(--text-secondary); font-size: 12px;">
                            Select a test step to view details
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="add-step-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add Test Step</div>
                <span class="material-icons modal-close" onclick="app.closeModal('add-step-modal')">close</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Operation</label>
                    <select class="form-input" id="step-operation" onchange="app.updateStepForm()">
                        <option value="get_state">Get State</option>
                        <option value="click">Click</option>
                        <option value="text_input">Text Input</option>
                        <option value="scroll_node_by">Scroll Node By</option>
                        <option value="get_node_layout">Get Node Layout</option>
                        <option value="take_screenshot">Take Screenshot</option>
                    </select>
                </div>
                <div id="step-form-fields"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('add-step-modal')">Cancel</button>
                <button class="btn" onclick="app.addTestStep()">Add Step</button>
            </div>
        </div>
    </div>

    <div id="import-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Import Test</div>
                <span class="material-icons modal-close" onclick="app.closeModal('import-modal')">close</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Paste JSON Test Data</label>
                    <textarea class="json-editor" id="import-json" rows="15"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('import-modal')">Cancel</button>
                <button class="btn" onclick="app.importTest()">Import</button>
            </div>
        </div>
    </div>

    <script>
        const app = {
            currentView: 'inspector',
            currentTest: 0,
            tests: [
                {
                    name: 'Default Test',
                    steps: [
                        { op: 'get_state', params: {}, response: null, breakpoint: false }
                    ]
                }
            ],
            selectedNode: null,
            apiUrl: 'http://localhost:8765',

            init() {
                this.loadUI();
                this.setupTerminal();
                this.renderTestSteps();
                
                // Try to get port from URL or detect it
                const params = new URLSearchParams(window.location.search);
                const port = params.get('port') || window.location.port || '8765';
                this.apiUrl = `http://localhost:${port}`;
            },

            async loadUI() {
                try {
                    const response = await this.sendCommand({ op: 'get_html_string' });
                    if (response.status === 'ok' && response.data) {
                        document.getElementById('html-content').innerHTML = 
                            `<pre style="background: var(--bg-secondary); padding: 15px; border-radius: 3px; overflow-x: auto;">${this.escapeHtml(response.data.value.html)}</pre>`;
                        
                        // Also update the tree view with a simplified version
                        this.updateDomTree(response.data.value.html);
                    }
                } catch (e) {
                    document.getElementById('html-content').innerHTML = 
                        `<div style="color: var(--error);">Failed to load UI: ${e.message}</div>`;
                }
            },

            updateDomTree(html) {
                // Simple tree representation
                const lines = html.split('\n');
                const treeHtml = lines.slice(0, 50).join('\n'); // Limit to first 50 lines
                document.getElementById('dom-tree').textContent = treeHtml;
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            switchView(view) {
                this.currentView = view;
                
                // Update activity bar
                document.querySelectorAll('.activity-icon').forEach(icon => {
                    icon.classList.remove('active');
                });
                document.querySelector(`[data-view="${view}"]`).classList.add('active');
                
                // Update views
                document.getElementById('inspector-view').classList.toggle('hidden', view !== 'inspector');
                document.getElementById('e2e-view').classList.toggle('hidden', view !== 'e2e');
            },

            async sendCommand(command) {
                const response = await fetch(this.apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(command)
                });
                return await response.json();
            },

            setupTerminal() {
                const input = document.getElementById('terminal-input');
                input.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        const cmd = input.value.trim();
                        if (!cmd) return;
                        
                        this.addTerminalOutput(`> ${cmd}`, 'command');
                        input.value = '';
                        
                        try {
                            const command = JSON.parse(cmd);
                            const response = await this.sendCommand(command);
                            this.addTerminalOutput(JSON.stringify(response, null, 2), 'response');
                        } catch (e) {
                            this.addTerminalOutput(`Error: ${e.message}`, 'error');
                        }
                    }
                });
            },

            addTerminalOutput(text, type = 'output') {
                const output = document.getElementById('terminal-output');
                const div = document.createElement('div');
                div.className = 'terminal-output';
                if (type === 'command') {
                    div.style.color = 'var(--success)';
                } else if (type === 'error') {
                    div.style.color = 'var(--error)';
                }
                div.textContent = text;
                output.insertBefore(div, output.lastElementChild);
                output.scrollTop = output.scrollHeight;
            },

            selectTest(index) {
                this.currentTest = index;
                document.querySelectorAll('.test-item').forEach((item, i) => {
                    item.classList.toggle('selected', i === index);
                });
                this.renderTestSteps();
            },

            renderTestSteps() {
                const test = this.tests[this.currentTest];
                const container = document.getElementById('test-steps');
                
                container.innerHTML = test.steps.map((step, i) => `
                    <div class="test-step ${step.breakpoint ? 'breakpoint' : ''}" data-step="${i}">
                        <div class="test-step-breakpoint" onclick="app.toggleBreakpoint(${i})">
                            <span class="material-icons">${step.breakpoint ? 'radio_button_checked' : 'radio_button_unchecked'}</span>
                        </div>
                        <div class="test-step-content" onclick="app.selectStep(${i})">
                            <div class="test-step-input">
                                ${i + 1}. ${step.op} ${Object.keys(step.params).length ? JSON.stringify(step.params) : ''}
                            </div>
                            ${step.response ? `
                                <div class="test-step-response">
                                    ${JSON.stringify(step.response, null, 2).slice(0, 200)}...
                                </div>
                            ` : ''}
                        </div>
                        <div class="test-step-actions">
                            <button class="btn btn-small btn-secondary" onclick="app.runSingleStep(${i})">
                                <span class="material-icons">play_arrow</span>
                            </button>
                            <button class="btn btn-small btn-secondary" onclick="app.deleteStep(${i})">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                // Add button to add new step
                const addBtn = document.createElement('button');
                addBtn.className = 'btn';
                addBtn.innerHTML = '<span class="material-icons">add</span> Add Step';
                addBtn.onclick = () => this.openModal('add-step-modal');
                container.appendChild(addBtn);
            },

            toggleBreakpoint(index) {
                this.tests[this.currentTest].steps[index].breakpoint = 
                    !this.tests[this.currentTest].steps[index].breakpoint;
                this.renderTestSteps();
            },

            selectStep(index) {
                const step = this.tests[this.currentTest].steps[index];
                const details = document.getElementById('step-details');
                
                details.innerHTML = `
                    <div class="property-group">
                        <div class="property-group-title">Request</div>
                        <div class="property-item">
                            <span class="property-key">Operation:</span>
                            <span class="property-value">${step.op}</span>
                        </div>
                        <div class="property-item">
                            <span class="property-key">Parameters:</span>
                            <span class="property-value">${JSON.stringify(step.params)}</span>
                        </div>
                    </div>
                    ${step.response ? `
                        <div class="property-group">
                            <div class="property-group-title">Response</div>
                            <pre style="background: var(--bg-tertiary); padding: 10px; border-radius: 3px; font-size: 11px; overflow-x: auto;">${JSON.stringify(step.response, null, 2)}</pre>
                        </div>
                    ` : ''}
                `;
            },

            async runTest() {
                const test = this.tests[this.currentTest];
                for (let i = 0; i < test.steps.length; i++) {
                    if (test.steps[i].breakpoint && i > 0) break;
                    await this.runSingleStep(i);
                }
            },

            async runToBreakpoint() {
                const test = this.tests[this.currentTest];
                for (let i = 0; i < test.steps.length; i++) {
                    await this.runSingleStep(i);
                    if (test.steps[i].breakpoint) break;
                }
            },

            async stepTest() {
                const test = this.tests[this.currentTest];
                const nextStep = test.steps.findIndex(s => !s.response);
                if (nextStep >= 0) {
                    await this.runSingleStep(nextStep);
                }
            },

            async runSingleStep(index) {
                const step = this.tests[this.currentTest].steps[index];
                const command = { op: step.op, ...step.params };
                
                try {
                    const response = await this.sendCommand(command);
                    step.response = response;
                    this.renderTestSteps();
                } catch (e) {
                    step.response = { error: e.message };
                    this.renderTestSteps();
                }
            },

            stopTest() {
                const test = this.tests[this.currentTest];
                test.steps.forEach(s => s.response = null);
                this.renderTestSteps();
            },

            deleteStep(index) {
                this.tests[this.currentTest].steps.splice(index, 1);
                this.renderTestSteps();
            },

            newTest() {
                this.tests.push({
                    name: `Test ${this.tests.length + 1}`,
                    steps: [{ op: 'get_state', params: {}, response: null, breakpoint: false }]
                });
                this.selectTest(this.tests.length - 1);
                this.renderTestList();
            },

            renderTestList() {
                const list = document.getElementById('test-list');
                list.innerHTML = this.tests.map((test, i) => `
                    <li class="test-item ${i === this.currentTest ? 'selected' : ''}" onclick="app.selectTest(${i})">
                        <span class="material-icons" style="font-size: 18px;">description</span>
                        ${test.name}
                    </li>
                `).join('');
            },

            openModal(modalId) {
                document.getElementById(modalId).classList.add('active');
                if (modalId === 'add-step-modal') {
                    this.updateStepForm();
                }
            },

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            },

            updateStepForm() {
                const op = document.getElementById('step-operation').value;
                const fields = document.getElementById('step-form-fields');
                
                const forms = {
                    click: `
                        <div class="form-group">
                            <label class="form-label">Selector (CSS)</label>
                            <input class="form-input" id="param-selector" placeholder=".button">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Or Node ID</label>
                            <input class="form-input" type="number" id="param-node_id" placeholder="42">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Or Text Content</label>
                            <input class="form-input" id="param-text" placeholder="Submit">
                        </div>
                    `,
                    text_input: `
                        <div class="form-group">
                            <label class="form-label">Text</label>
                            <input class="form-input" id="param-text" placeholder="Hello World">
                        </div>
                    `,
                    scroll_node_by: `
                        <div class="form-group">
                            <label class="form-label">Selector</label>
                            <input class="form-input" id="param-selector" placeholder=".scrollable">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Delta X</label>
                            <input class="form-input" type="number" id="param-delta_x" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Delta Y</label>
                            <input class="form-input" type="number" id="param-delta_y" value="100">
                        </div>
                    `,
                    get_node_layout: `
                        <div class="form-group">
                            <label class="form-label">Selector</label>
                            <input class="form-input" id="param-selector" placeholder=".element">
                        </div>
                    `,
                    get_state: '',
                    take_screenshot: ''
                };
                
                fields.innerHTML = forms[op] || '';
            },

            addTestStep() {
                const op = document.getElementById('step-operation').value;
                const params = {};
                
                // Collect all param inputs
                document.querySelectorAll('[id^="param-"]').forEach(input => {
                    const key = input.id.replace('param-', '');
                    if (input.value) {
                        params[key] = input.type === 'number' ? parseFloat(input.value) : input.value;
                    }
                });
                
                this.tests[this.currentTest].steps.push({
                    op,
                    params,
                    response: null,
                    breakpoint: false
                });
                
                this.renderTestSteps();
                this.closeModal('add-step-modal');
            },

            openImportModal() {
                this.openModal('import-modal');
            },

            importTest() {
                try {
                    const json = document.getElementById('import-json').value;
                    const data = JSON.parse(json);
                    
                    if (Array.isArray(data)) {
                        // Multiple tests
                        data.forEach(test => this.tests.push(test));
                    } else {
                        // Single test
                        this.tests.push(data);
                    }
                    
                    this.renderTestList();
                    this.closeModal('import-modal');
                } catch (e) {
                    alert('Invalid JSON: ' + e.message);
                }
            },

            importUI() {
                this.loadUI();
            },

            exportWorkspace() {
                const workspace = {
                    tests: this.tests,
                    currentTest: this.currentTest,
                    apiUrl: this.apiUrl
                };
                this.downloadJSON(workspace, 'azul-workspace.json');
            },

            exportTests() {
                this.downloadJSON(this.tests, 'azul-tests.json');
            },

            downloadJSON(data, filename) {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }
        };

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>