<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azul Debugger</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            /* VSCode Dark Theme Colors */
            --bg-root: #1e1e1e;
            --bg-sidebar: #252526;
            --bg-activity: #333333;
            --bg-panel: #1e1e1e;
            --bg-header: #3c3c3c;
            --bg-input: #3c3c3c;
            --bg-hover: #2a2d2e;
            --bg-selection: #37373d;
            --border: #454545;
            --text-main: #cccccc;
            --text-muted: #858585;
            --accent: #007acc;
            --success: #4ec9b0;
            --error: #f14c4c;
            --warning: #cca700;
            --variable: #9cdcfe;
            --string: #ce9178;
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-root);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            font-size: 13px;
        }

        /* --- Utilities --- */
        .flex { display: flex; }
        .col { flex-direction: column; }
        .row { flex-direction: row; }
        .grow { flex-grow: 1; }
        .hidden { display: none !important; }
        .scroll { overflow: auto; }
        .mono { font-family: 'Consolas', 'Monaco', monospace; }
        .pointer { cursor: pointer; }

        /* --- Menu Bar --- */
        .menubar {
            height: 30px;
            background-color: var(--bg-header);
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 13px;
            user-select: none;
        }
        .menu-item {
            padding: 4px 8px;
            cursor: pointer;
        }
        .menu-item:hover { background-color: var(--bg-hover); }

        /* --- Main Layout --- */
        .workbench { display: flex; flex: 1; overflow: hidden; }

        /* --- Activity Bar (Far Left) --- */
        .activity-bar {
            width: 48px;
            background-color: var(--bg-activity);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
        }
        .activity-icon {
            width: 48px;
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            opacity: 0.6;
            border-left: 2px solid transparent;
        }
        .activity-icon:hover { opacity: 1; }
        .activity-icon.active { 
            opacity: 1; 
            border-left-color: var(--text-main); 
        }
        .activity-icon span { font-size: 24px; color: var(--text-main); }

        /* --- Sidebar (Left Panel) --- */
        .sidebar {
            width: 250px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 10px 15px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-content { flex: 1; overflow-y: auto; }
        
        .list-item {
            padding: 4px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .list-item:hover { background-color: var(--bg-hover); }
        .list-item.selected { background-color: var(--bg-selection); color: white; }

        /* --- Editor Area (Center) --- */
        .editor-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-root);
            position: relative; /* For floating controls */
        }

        .editor-tabs {
            height: 35px;
            background-color: var(--bg-sidebar);
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }
        .tab {
            padding: 0 15px;
            height: 100%;
            display: flex;
            align-items: center;
            background-color: var(--bg-root);
            border-top: 1px solid var(--accent);
            color: var(--text-main);
            font-size: 13px;
            gap: 5px;
        }

        .editor-content { flex: 1; overflow: auto; padding: 0; position: relative; }

        /* --- Panel (Bottom Terminal) --- */
        .bottom-panel {
            height: 200px;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .panel-header {
            display: flex;
            gap: 15px;
            padding: 5px 15px;
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            font-size: 11px;
        }
        .terminal-output {
            flex: 1;
            padding: 10px;
            font-family: monospace;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-entry.command { color: var(--success); }
        .log-entry.error { color: var(--error); }
        .log-entry.info { color: var(--text-muted); }

        .terminal-input-row {
            display: flex;
            background-color: var(--bg-input);
            padding: 5px;
        }
        .terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-family: monospace;
        }

        /* --- Secondary Sidebar (Right) --- */
        .secondary-sidebar {
            width: 300px;
            background-color: var(--bg-sidebar);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        /* --- Specific UI: Tree View (Inspector) --- */
        .tree-node {
            padding: 2px 0 2px 10px;
            cursor: pointer;
            white-space: nowrap;
        }
        .tree-node:hover > .node-content { background-color: var(--bg-hover); }
        .tree-node.selected > .node-content { background-color: var(--bg-selection); }
        .node-tag { color: var(--accent); }
        .node-attr { color: var(--variable); }
        .node-val { color: var(--string); }

        /* --- Specific UI: Test Runner --- */
        .floating-controls {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bg-sidebar);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 5px;
            display: flex;
            gap: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 100;
        }
        
        .icon-btn {
            background: transparent;
            border: none;
            color: var(--text-main);
            cursor: pointer;
            border-radius: 3px;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-btn:hover { background-color: var(--bg-hover); }
        .icon-btn.success { color: var(--success); }
        .icon-btn.danger { color: var(--error); }
        .icon-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .step-list { padding: 10px; }
        .step-item {
            display: flex;
            align-items: center;
            background-color: var(--bg-sidebar);
            margin-bottom: 4px;
            border-radius: 3px;
            border: 1px solid transparent;
            padding: 5px;
        }
        .step-item:hover { border-color: var(--border); }
        .step-item.active { border-left: 3px solid var(--accent); }
        .step-item.pass { border-left: 3px solid var(--success); }
        .step-item.fail { border-left: 3px solid var(--error); }
        
        .step-gutter { width: 30px; display: flex; justify-content: center; }
        .breakpoint { width: 10px; height: 10px; border-radius: 50%; background: var(--error); opacity: 0; cursor: pointer; transition: opacity 0.2s; }
        .breakpoint.active { opacity: 1; }
        .step-item:hover .breakpoint { opacity: 0.5; }
        .step-item:hover .breakpoint.active { opacity: 1; }

        .step-content { flex: 1; display: flex; flex-direction: column; cursor: pointer; }
        .step-title { font-weight: bold; font-size: 12px; }
        .step-meta { font-size: 11px; color: var(--text-muted); display: flex; gap: 10px; }

        /* --- Forms --- */
        .form-group { padding: 10px; border-bottom: 1px solid var(--border); }
        .form-label { display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 11px; }
        .form-control {
            width: 100%;
            background-color: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 5px;
            border-radius: 2px;
        }
        .btn-primary {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 2px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        .btn-primary:hover { opacity: 0.9; }

        /* JSON Syntax Highlighting */
        .json-key { color: var(--variable); }
        .json-string { color: var(--string); }
        .json-number { color: var(--success); }
        .json-boolean { color: var(--accent); }

    </style>
</head>
<body>

    <!-- Menu Bar -->
    <div class="menubar">
        <div class="menu-item" onclick="app.handlers.newTest()">File</div>
        <div class="menu-item" onclick="document.getElementById('file-input').click()">Import</div>
        <div class="menu-item" onclick="app.handlers.exportTests()">Export</div>
        <div style="flex:1"></div>
        <div class="menu-item" id="connection-status" style="color: var(--warning)">Disconnected</div>
    </div>

    <!-- Hidden File Input for Import -->
    <input type="file" id="file-input" class="hidden" accept=".json" onchange="app.handlers.importFile(this)">

    <!-- Main Workbench -->
    <div class="workbench">
        
        <!-- Activity Bar -->
        <div class="activity-bar">
            <div class="activity-icon active" data-view="inspector" onclick="app.ui.switchView('inspector')">
                <span class="material-icons">account_tree</span>
            </div>
            <div class="activity-icon" data-view="testing" onclick="app.ui.switchView('testing')">
                <span class="material-icons">bug_report</span>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <span id="sidebar-title">DOM Explorer</span>
                <span class="material-icons pointer" style="font-size: 16px" onclick="app.handlers.refreshSidebar()">refresh</span>
            </div>
            
            <!-- Inspector Sidebar Content -->
            <div id="sidebar-inspector" class="sidebar-content mono" style="font-size: 12px;">
                <div style="padding:10px; color: var(--text-muted)">Loading DOM...</div>
            </div>

            <!-- Testing Sidebar Content -->
            <div id="sidebar-testing" class="sidebar-content hidden">
                <div style="padding: 10px;">
                    <button class="btn-primary" onclick="app.handlers.newTest()">+ New Test</button>
                </div>
                <div id="test-list-container">
                    <!-- Tests injected here -->
                </div>
            </div>
        </div>

        <!-- Main Editor Group -->
        <div class="editor-group">
            <div class="editor-tabs">
                <div class="tab">
                    <span class="material-icons" style="font-size: 14px; color: var(--accent)">description</span>
                    <span id="tab-title">main.html</span>
                </div>
            </div>

            <!-- Editor Content -->
            <div class="editor-content">
                
                <!-- View: Inspector -->
                <div id="view-inspector" class="flex col" style="height: 100%; padding: 20px;">
                    <h3>UI Preview</h3>
                    <div style="color: var(--text-muted); margin-bottom: 10px;">
                        Visual representation of the node structure.
                    </div>
                    <div id="dom-preview" class="mono" style="background: var(--bg-sidebar); padding: 15px; border-radius: 4px; overflow: auto; white-space: pre;">
                        &lt;!-- DOM content will appear here --&gt;
                    </div>
                </div>

                <!-- View: Testing -->
                <div id="view-testing" class="hidden" style="height: 100%; position: relative;">
                    <!-- Floating Controls -->
                    <div class="floating-controls">
                        <button class="icon-btn success" title="Run Test" onclick="app.runner.run()"><span class="material-icons">play_arrow</span></button>
                        <button class="icon-btn" title="Pause" onclick="app.runner.pause()"><span class="material-icons">pause</span></button>
                        <button class="icon-btn" title="Step Over" onclick="app.runner.step()"><span class="material-icons">redo</span></button>
                        <button class="icon-btn danger" title="Stop/Reset" onclick="app.runner.reset()"><span class="material-icons">stop</span></button>
                    </div>

                    <div id="steps-container" class="step-list">
                        <!-- Steps injected here -->
                        <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                            No test selected or empty test.
                        </div>
                    </div>
                    
                    <div style="padding: 10px; border-top: 1px solid var(--border);">
                        <button class="btn-primary" style="width: auto;" onclick="app.ui.showAddStepForm()">+ Add Step</button>
                    </div>
                </div>
            </div>

            <!-- Bottom Panel (Terminal) -->
            <div class="bottom-panel">
                <div class="panel-header">
                    <span>Terminal</span>
                    <span style="opacity: 0.5">Debug Console</span>
                </div>
                <div id="terminal-output" class="terminal-output"></div>
                <div class="terminal-input-row">
                    <span style="color: var(--accent); margin-right: 5px;">></span>
                    <input type="text" id="terminal-cmd" class="terminal-input" placeholder='{"op": "get_state"}' onkeydown="if(event.key==='Enter') app.handlers.terminalEnter(this)">
                </div>
            </div>
        </div>

        <!-- Secondary Sidebar (Right - Properties / Step Details) -->
        <div class="secondary-sidebar">
            <div class="sidebar-header">Properties / Details</div>
            
            <div id="prop-panel" class="sidebar-content">
                <!-- Dynamic Content Form -->
                <div id="details-content" style="padding: 10px;">
                    <p style="color: var(--text-muted)">Select a node or a test step to view details.</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script>
/**
 * Application State and Logic
 */
const app = {
    config: {
        apiUrl: 'http://localhost:8765', // Default Azul debug port
        isMock: false // Will toggle to true if connection fails
    },
    state: {
        currentView: 'inspector',
        activeTestId: null,
        tests: [],
        executionStatus: 'idle', // idle, running, paused
        currentStepIndex: -1,
        selectedNodeId: null
    },
    // Schema definition for the UI builder
    schema: {
        commands: {
            'get_state': { params: [] },
            'click': { 
                params: [
                    { name: 'selector', type: 'text', placeholder: '.button-class' },
                    { name: 'text', type: 'text', placeholder: 'Button Label' }
                ] 
            },
            'text_input': {
                params: [
                    { name: 'text', type: 'text', placeholder: 'Input text' }
                ]
            },
            'scroll': {
                params: [
                    { name: 'delta_x', type: 'number', value: 0 },
                    { name: 'delta_y', type: 'number', value: 50 }
                ]
            },
            'assert_eq': {
                params: [
                    { name: 'path', type: 'text', placeholder: 'window_state.width' },
                    { name: 'value', type: 'text', placeholder: '1024' } // simplified as text/json
                ]
            },
            'wait': {
                params: [
                    { name: 'ms', type: 'number', value: 500 }
                ]
            },
            'take_screenshot': { params: [] }
        }
    },

    init: async function() {
        this.log('Initializing Azul Debugger...', 'info');
        
        // Load local storage if available
        const savedTests = localStorage.getItem('azul_tests');
        if (savedTests) {
            this.state.tests = JSON.parse(savedTests);
        } else {
            // Default Demo Test
            this.handlers.newTest(); 
        }

        // Try to connect to backend
        try {
            await this.api.post({ op: 'get_state' });
            document.getElementById('connection-status').innerText = 'Connected';
            document.getElementById('connection-status').style.color = 'var(--success)';
        } catch (e) {
            this.log('Connection failed. Switching to Mock Mode.', 'warning');
            this.config.isMock = true;
            document.getElementById('connection-status').innerText = 'Mock Mode';
        }

        this.ui.renderTestList();
        this.handlers.refreshSidebar();
    },

    log: function(msg, type = 'info') {
        const term = document.getElementById('terminal-output');
        const div = document.createElement('div');
        div.className = `log-entry ${type}`;
        
        const time = new Date().toLocaleTimeString().split(' ')[0];
        div.innerText = `[${time}] ${typeof msg === 'object' ? JSON.stringify(msg) : msg}`;
        
        term.appendChild(div);
        term.scrollTop = term.scrollHeight;
    },

    api: {
        post: async function(payload) {
            if (app.config.isMock) return app.api.mockResponse(payload);

            try {
                const res = await fetch(app.config.apiUrl, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const json = await res.json();
                app.log(payload, 'command');
                app.log(json, 'info');
                return json;
            } catch (e) {
                app.log(`Network Error: ${e.message}`, 'error');
                throw e;
            }
        },

        mockResponse: async function(payload) {
            // Simulated backend logic
            await new Promise(r => setTimeout(r, 100)); // Latency
            app.log(payload, 'command');
            
            let response = { status: 'ok', request_id: Date.now(), data: {} };
            
            if (payload.op === 'get_html_string') {
                response.data.html = `<body>\n  <div id="app">\n    <div class="header">App Header</div>\n    <button class="btn">Click Me</button>\n  </div>\n</body>`;
            } else if (payload.op === 'get_dom_tree') {
                response.data = { nodes: [{id: 0, tag: 'window'}, {id: 1, tag: 'div'}] };
            } else {
                response.data.message = "Mock execution successful";
            }
            return response;
        }
    },

    ui: {
        switchView: function(viewName) {
            app.state.currentView = viewName;
            
            // Icons
            document.querySelectorAll('.activity-icon').forEach(el => {
                el.classList.toggle('active', el.dataset.view === viewName);
            });

            // Sidebars
            document.getElementById('sidebar-inspector').classList.toggle('hidden', viewName !== 'inspector');
            document.getElementById('sidebar-testing').classList.toggle('hidden', viewName !== 'testing');
            
            // Main Views
            document.getElementById('view-inspector').classList.toggle('hidden', viewName !== 'inspector');
            document.getElementById('view-testing').classList.toggle('hidden', viewName !== 'testing');

            // Titles
            document.getElementById('sidebar-title').innerText = viewName === 'inspector' ? 'DOM Explorer' : 'Test Explorer';
            document.getElementById('tab-title').innerText = viewName === 'inspector' ? 'main.html' : 'runner.e2e';
        },

        renderTree: function(htmlString) {
            // Simple text parser for demo purposes
            // In a real app, parse HTML string to DOM object
            const container = document.getElementById('sidebar-inspector');
            container.innerHTML = '';
            
            const lines = htmlString.split('\n');
            lines.forEach((line, idx) => {
                const div = document.createElement('div');
                div.className = 'tree-node';
                div.onclick = () => app.handlers.nodeSelected(idx);
                div.innerHTML = `<span class="node-content">${line.replace(/</g, '&lt;')}</span>`;
                container.appendChild(div);
            });
            document.getElementById('dom-preview').textContent = htmlString;
        },

        renderTestList: function() {
            const container = document.getElementById('test-list-container');
            container.innerHTML = '';
            app.state.tests.forEach(test => {
                const div = document.createElement('div');
                div.className = `list-item ${app.state.activeTestId === test.id ? 'selected' : ''}`;
                div.onclick = () => app.handlers.selectTest(test.id);
                div.innerHTML = `<span class="material-icons" style="font-size:16px">description</span> ${test.name}`;
                container.appendChild(div);
            });
        },

        renderSteps: function() {
            const container = document.getElementById('steps-container');
            container.innerHTML = '';
            
            const activeTest = app.state.tests.find(t => t.id === app.state.activeTestId);
            if (!activeTest) return;

            activeTest.steps.forEach((step, idx) => {
                const div = document.createElement('div');
                let statusClass = '';
                if (step.status === 'pass') statusClass = 'pass';
                if (step.status === 'fail') statusClass = 'fail';
                if (app.state.currentStepIndex === idx) statusClass = 'active';

                div.className = `step-item ${statusClass}`;
                
                div.innerHTML = `
                    <div class="step-gutter">
                        <div class="breakpoint ${step.breakpoint ? 'active' : ''}" 
                             onclick="app.handlers.toggleBreakpoint(${idx}, event)"></div>
                    </div>
                    <div class="step-content" onclick="app.ui.showStepDetails(${idx})">
                        <div class="step-title">${step.op}</div>
                        <div class="step-meta">
                            ${Object.values(step.params).join(', ') || 'No params'}
                        </div>
                        ${step.error ? `<div style="color:var(--error); font-size:10px">${step.error}</div>` : ''}
                    </div>
                    <div class="step-gutter">
                        <span class="material-icons pointer" style="font-size:14px" onclick="app.handlers.deleteStep(${idx}, event)">close</span>
                    </div>
                `;
                container.appendChild(div);
            });
        },

        showAddStepForm: function() {
            const container = document.getElementById('details-content');
            
            // Build Op Select
            let opsHtml = `<select id="new-step-op" class="form-control" onchange="app.ui.updateStepParamsForm()">`;
            for(let op in app.schema.commands) {
                opsHtml += `<option value="${op}">${op}</option>`;
            }
            opsHtml += `</select>`;

            container.innerHTML = `
                <h3>Add Step</h3>
                <div class="form-group">
                    <label class="form-label">Operation</label>
                    ${opsHtml}
                </div>
                <div id="step-params-container"></div>
                <button class="btn-primary" onclick="app.handlers.addStepFromForm()">Add Step</button>
            `;
            
            this.updateStepParamsForm();
        },

        updateStepParamsForm: function() {
            const op = document.getElementById('new-step-op').value;
            const schema = app.schema.commands[op];
            const container = document.getElementById('step-params-container');
            
            let html = '';
            schema.params.forEach(p => {
                html += `
                    <div class="form-group">
                        <label class="form-label">${p.name} (${p.type})</label>
                        <input type="${p.type === 'number' ? 'number' : 'text'}" 
                               class="form-control step-param-input" 
                               data-name="${p.name}" 
                               placeholder="${p.placeholder || ''}"
                               value="${p.value !== undefined ? p.value : ''}">
                    </div>
                `;
            });
            container.innerHTML = html;
        },

        showStepDetails: function(idx) {
            const test = app.state.tests.find(t => t.id === app.state.activeTestId);
            const step = test.steps[idx];
            const container = document.getElementById('details-content');

            container.innerHTML = `
                <h3>Step ${idx + 1}: ${step.op}</h3>
                <div class="mono" style="font-size: 11px; margin-bottom: 10px;">
                    ${JSON.stringify(step.params, null, 2)}
                </div>
                <h4>Last Response</h4>
                <div class="mono" style="background: var(--bg-input); padding: 5px; border-radius: 3px; max-height: 200px; overflow: auto; font-size: 11px;">
                    ${step.lastResponse ? JSON.stringify(step.lastResponse, null, 2) : 'Not executed'}
                </div>
            `;
        }
    },

    handlers: {
        newTest: function() {
            const newTest = {
                id: Date.now(),
                name: `Test ${app.state.tests.length + 1}`,
                steps: [
                    { op: 'get_state', params: {}, breakpoint: false }
                ]
            };
            app.state.tests.push(newTest);
            this.save();
            this.selectTest(newTest.id);
            app.ui.renderTestList();
            app.ui.switchView('testing');
        },

        selectTest: function(id) {
            app.state.activeTestId = id;
            app.ui.renderTestList();
            app.ui.renderSteps();
        },

        addStepFromForm: function() {
            if (!app.state.activeTestId) return;
            const op = document.getElementById('new-step-op').value;
            const inputs = document.querySelectorAll('.step-param-input');
            const params = {};
            
            inputs.forEach(input => {
                const val = input.value;
                params[input.dataset.name] = input.type === 'number' ? parseFloat(val) : val;
            });

            const test = app.state.tests.find(t => t.id === app.state.activeTestId);
            test.steps.push({ op, params, breakpoint: false });
            app.handlers.save();
            app.ui.renderSteps();
        },

        deleteStep: function(idx, e) {
            e.stopPropagation();
            const test = app.state.tests.find(t => t.id === app.state.activeTestId);
            test.steps.splice(idx, 1);
            app.handlers.save();
            app.ui.renderSteps();
        },

        toggleBreakpoint: function(idx, e) {
            e.stopPropagation();
            const test = app.state.tests.find(t => t.id === app.state.activeTestId);
            test.steps[idx].breakpoint = !test.steps[idx].breakpoint;
            app.handlers.save();
            app.ui.renderSteps();
        },

        refreshSidebar: async function() {
            try {
                const res = await app.api.post({ op: 'get_html_string' });
                if(res.data && res.data.html) {
                    app.ui.renderTree(res.data.html);
                }
            } catch(e) { /* ignore */ }
        },

        nodeSelected: async function(idx) {
            // Visualize selection
            document.querySelectorAll('.tree-node').forEach((el, i) => {
                el.classList.toggle('selected', i === idx);
            });
            
            // Fetch properties
            const container = document.getElementById('details-content');
            container.innerHTML = '<div style="color:var(--text-muted)">Fetching node properties...</div>';
            
            try {
                // In a real scenario, map the index to a node_id
                const props = await app.api.post({ op: 'get_node_css_properties', node_id: idx });
                const layout = await app.api.post({ op: 'get_node_layout', node_id: idx });
                
                let html = `<h3>Node ${idx}</h3>`;
                
                if (layout.data) {
                    html += `<h4>Layout</h4><pre class="mono" style="font-size:11px">${JSON.stringify(layout.data, null, 2)}</pre>`;
                }
                
                if (props.data) {
                    html += `<h4>CSS Properties</h4>`;
                    // Assume props returns a list
                    html += `<div class="mono" style="font-size:11px; max-height:300px; overflow:auto;">`;
                    // Mocking prop list display
                    const list = props.data.properties || ["display: block", "color: red"]; 
                    list.forEach(p => html += `<div>${p}</div>`);
                    html += `</div>`;
                }

                container.innerHTML = html;
            } catch(e) {
                container.innerHTML = `<div style="color:var(--error)">Failed to load properties.</div>`;
            }
        },

        terminalEnter: async function(input) {
            try {
                const cmd = JSON.parse(input.value);
                await app.api.post(cmd);
                input.value = '';
            } catch (e) {
                app.log('Invalid JSON command', 'error');
            }
        },

        exportTests: function() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(app.state.tests));
            const anchor = document.createElement('a');
            anchor.setAttribute("href", dataStr);
            anchor.setAttribute("download", "azul_tests.json");
            document.body.appendChild(anchor);
            anchor.click();
            anchor.remove();
        },

        importFile: function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    // Simple merge strategy
                    app.state.tests = app.state.tests.concat(imported);
                    app.handlers.save();
                    app.ui.renderTestList();
                } catch(err) {
                    alert("Invalid JSON file");
                }
            };
            reader.readAsText(file);
        },

        save: function() {
            localStorage.setItem('azul_tests', JSON.stringify(app.state.tests));
        }
    },

    runner: {
        run: async function() {
            if (app.state.executionStatus === 'running') return;
            
            app.state.executionStatus = 'running';
            const test = app.state.tests.find(t => t.id === app.state.activeTestId);
            
            // Clear previous statuses
            if (app.state.currentStepIndex === -1) {
                test.steps.forEach(s => { delete s.status; delete s.error; delete s.lastResponse; });
                app.ui.renderSteps();
                app.state.currentStepIndex = 0;
            }

            this.loop();
        },

        loop: async function() {
            const test = app.state.tests.find(t => t.id === app.state.activeTestId);
            
            if (app.state.executionStatus !== 'running') return;
            if (app.state.currentStepIndex >= test.steps.length) {
                app.state.executionStatus = 'idle';
                app.state.currentStepIndex = -1;
                app.ui.renderSteps();
                app.log(`Test '${test.name}' completed.`, 'success');
                return;
            }

            const idx = app.state.currentStepIndex;
            const step = test.steps[idx];

            // Highlight current step
            app.ui.renderSteps();

            // Check Breakpoint
            if (step.breakpoint && app.state.currentStepIndex > 0 && !step.breakHit) {
                app.state.executionStatus = 'paused';
                step.breakHit = true; // Mark as hit so we can step over it next time
                app.log(`Paused at breakpoint: Step ${idx + 1}`, 'warning');
                return;
            }
            step.breakHit = false; // Reset for next run

            // Execute
            try {
                // Handling Client-side Assertions
                if (step.op.startsWith('assert_')) {
                    // Logic to check previous step response or fetch state
                    // For prototype, let's fetch state
                    const state = await app.api.post({ op: 'get_state' });
                    step.lastResponse = state;
                    
                    // very simple logic for prototype: check path existence in data
                    // Real impl needs deep property access helper
                    if (step.op === 'assert_eq' && state.data) {
                        // Dummy check
                        step.status = 'pass';
                    } else {
                        step.status = 'pass'; // Default pass for demo
                    }
                } else {
                    // Standard Command
                    const payload = { op: step.op, ...step.params };
                    const res = await app.api.post(payload);
                    step.lastResponse = res;
                    
                    if (res.status === 'error') throw new Error(res.message);
                    step.status = 'pass';
                }
            } catch (e) {
                step.status = 'fail';
                step.error = e.message;
                app.state.executionStatus = 'idle';
                app.log(`Step ${idx + 1} Failed: ${e.message}`, 'error');
                app.ui.renderSteps();
                return;
            }

            // Move Next
            app.state.currentStepIndex++;
            // Small delay for visual tracking
            setTimeout(() => app.runner.loop(), 250); 
        },

        pause: function() {
            if (app.state.executionStatus === 'running') {
                app.state.executionStatus = 'paused';
                app.log('Test paused.', 'warning');
            }
        },

        step: function() {
            if (app.state.executionStatus === 'paused' || app.state.executionStatus === 'idle') {
                if(app.state.executionStatus === 'idle' && app.state.currentStepIndex === -1) {
                     app.state.currentStepIndex = 0;
                }
                app.state.executionStatus = 'running';
                // Run one loop iteration then pause if not finished
                const originalLoop = app.runner.loop;
                
                // Hacky single step logic for demo
                // Ideally, loop() handles single step based on flag
                app.runner.loop().then(() => {
                     if(app.state.executionStatus === 'running') {
                         app.state.executionStatus = 'paused';
                     }
                });
            }
        },

        reset: function() {
            app.state.executionStatus = 'idle';
            app.state.currentStepIndex = -1;
            const test = app.state.tests.find(t => t.id === app.state.activeTestId);
            if(test) {
                test.steps.forEach(s => { delete s.status; delete s.error; });
            }
            app.ui.renderSteps();
            app.log('Test execution reset.', 'info');
        }
    }
};

// Start
window.onload = () => app.init();

    </script>
</body>
</html>