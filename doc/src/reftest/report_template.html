<!DOCTYPE html>
<html lang="en">
<head>
  <title>Azul CSS Reftest Results</title>
  <meta charset='utf-8'/>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
  <meta name='description' content='CSS rendering reference tests for azul-layout'>
  <link rel='shortcut icon' type='image/x-icon' href='https://azul.rs/favicon.ico'>
  <link rel='stylesheet' type='text/css' href='https://azul.rs/main.css'>
  <style>
    /* Reftest-specific styles */
    :root {
      --color-pass: #2ecc71;
      --color-warning: #f39c12;
      --color-fail: #e74c3c;
      --color-primary: #4a6bdf;
      --font-mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      --border-radius: 6px;
    }

    /* Summary bar - single compact line */
    .summary-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: center;
      padding: 0.75rem 0;
      margin-bottom: 1rem;
      border-bottom: 1px solid #ddd;
      font-size: 0.95rem;
    }
    .summary-bar .stat {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }
    .summary-bar .stat-value {
      font-weight: 700;
    }
    .summary-bar .stat-value.pass { color: var(--color-pass); }
    .summary-bar .stat-value.fail { color: var(--color-fail); }
    .summary-bar .stat-value.warning { color: var(--color-warning); }
    .summary-bar .meta {
      color: #666;
      font-size: 0.85rem;
    }
    .summary-bar .meta a { color: var(--color-primary); }
    .summary-bar .meta code {
      background: #f0f0f0;
      padding: 0.1rem 0.4rem;
      border-radius: 3px;
      font-size: 0.8rem;
    }

    /* Controls row */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      align-items: center;
    }
    .search-input {
      flex: 1;
      min-width: 200px;
      max-width: 350px;
      padding: 0.5rem 0.75rem;
      font-size: 0.9rem;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      font-family: inherit;
    }
    .search-input:focus { outline: 2px solid var(--color-primary); }
    .btn-group {
      display: flex;
      gap: 0.25rem;
    }
    .btn {
      padding: 0.5rem 0.75rem;
      background: #f5f5f5;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.15s;
    }
    .btn:hover { background: #e8e8e8; }
    .btn.active { background: var(--color-primary); color: white; border-color: var(--color-primary); }
    .btn.pass { border-left: 3px solid var(--color-pass); }
    .btn.warning { border-left: 3px solid var(--color-warning); }
    .btn.fail { border-left: 3px solid var(--color-fail); }

    /* Test list */
    .test-list { margin-top: 1rem; }
    .category-header {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--color-primary);
      margin: 1.5rem 0 0.5rem 0;
      padding-bottom: 0.25rem;
      border-bottom: 2px solid var(--color-primary);
    }
    .category-header:first-child { margin-top: 0; }

    .test-card {
      background: #fafafa;
      border-radius: var(--border-radius);
      margin-bottom: 0.5rem;
      border-left: 4px solid #ccc;
      overflow: hidden;
    }
    .test-card.pass { border-left-color: var(--color-pass); background: rgba(46, 204, 113, 0.05); }
    .test-card.warning { border-left-color: var(--color-warning); background: rgba(243, 156, 18, 0.05); }
    .test-card.fail { border-left-color: var(--color-fail); background: rgba(231, 76, 60, 0.05); }

    .test-header {
      padding: 0.6rem 0.8rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    .test-header:hover { background: rgba(0,0,0,0.03); }
    .test-header-left {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .collapse-icon {
      font-size: 0.8rem;
      transition: transform 0.15s;
      color: #666;
    }
    .test-card.collapsed .collapse-icon { transform: rotate(-90deg); }
    .test-card.collapsed .test-body { display: none; }
    .test-title {
      margin: 0;
      font-size: 0.95rem;
      font-weight: 500;
    }
    .test-badge {
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      color: white;
    }
    .test-badge.pass { background: var(--color-pass); }
    .test-badge.warning { background: var(--color-warning); }
    .test-badge.fail { background: var(--color-fail); }
    .diff-count {
      font-size: 0.8rem;
      color: #666;
      margin-left: 0.5rem;
    }

    .test-body { padding: 0.8rem; border-top: 1px solid #eee; }
    .test-images {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin-bottom: 0.75rem;
    }
    .test-img-box { text-align: center; }
    .test-img-box img {
      max-width: 100%;
      height: auto;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
    }
    .test-img-label {
      margin-top: 0.3rem;
      font-size: 0.8rem;
      color: #666;
    }
    .test-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }
    .action-btn {
      padding: 0.35rem 0.6rem;
      background: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.15s;
    }
    .action-btn:hover { background: #e0e0e0; }
    .action-btn.primary { background: var(--color-primary); color: white; border-color: var(--color-primary); }
    .action-btn.primary:hover { background: #3a5bc9; }

    /* Overlay modal */
    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      overflow-y: auto;
      backdrop-filter: blur(2px);
    }
    .overlay-content {
      background: white;
      margin: 2rem auto;
      padding: 1.25rem;
      max-width: 95%;
      width: 900px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .overlay-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #ddd;
    }
    .overlay-title { margin: 0; font-size: 1.2rem; }
    .overlay-close {
      font-size: 1.5rem;
      cursor: pointer;
      width: 28px; height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    .overlay-close:hover { background: #f0f0f0; }
    .overlay-data {
      max-height: 65vh;
      overflow: auto;
      background: #f8f8f8;
      padding: 0.75rem;
      border-radius: var(--border-radius);
      font-family: var(--font-mono);
      font-size: 0.85rem;
      white-space: pre-wrap;
      line-height: 1.4;
    }

    /* Empty / no results */
    .no-results {
      display: none;
      text-align: center;
      padding: 2rem;
      color: #666;
      background: #f9f9f9;
      border-radius: var(--border-radius);
    }

    /* Override main.css for reftest page */
    main { min-height: auto; padding: 30px; }
    main h1 { margin-bottom: 0.5rem; font-size: 1.8rem; }

    @media (max-width: 720px) {
      .summary-bar { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
      .controls { flex-direction: column; }
      .search-input { max-width: none; }
    }
  </style>
</head>
<body>
  <div class="center">
    <aside>
      <header>
        <h1 style="display:none;">Azul GUI Framework</h1>
        <a href="https://azul.rs"><img src="https://azul.rs/logo.svg" alt="Azul Logo" style="width:100px;height:100px;"></a>
      </header>
      <nav>
        <ul class='nav-grid'>
          <li><a href='https://azul.rs'>overview</a></li>
          <li><a href='https://azul.rs/releases.html'>releases</a></li>
          <li><a href='https://github.com/fschutt/azul'>code</a></li>
          <li><a href='https://discord.gg/V96ZGKqQvn'>discord</a></li>
          <li><a href='https://azul.rs/guide.html'>guide</a></li>
          <li><a href='https://azul.rs/api.html'>api</a></li>
          <li class="active"><a href='https://azul.rs/reftest.html'>reftests</a></li>
          <li><a href='https://azul.rs/blog.html'>blog</a></li>
          <li><a href='https://azul.rs/donate.html'>donate</a></li>
        </ul>
      </nav>
    </aside>
    <main>
      <h1>azul-layout reftest results</h1>

      <!-- Compact summary bar -->
      <div class="summary-bar">
        <span class="stat"><span class="stat-value" id="totalTests">0</span> tests</span>
        <span class="stat"><span class="stat-value pass" id="passedTests">0</span> passed (<span id="passPercentage">0</span>%)</span>
        <span class="stat"><span class="stat-value fail" id="failedTests">0</span> failed (<span id="failPercentage">0</span>%)</span>
        <span class="stat"><span class="stat-value warning" id="warningTests">0</span> warning (<span id="warnPercentage">0</span>%)</span>
        <span class="meta">
          CURRENT_TIME · rev <a href="https://github.com/fschutt/azul/commit/GIT_HASH"><code>GIT_HASH</code></a> · CHROME_VERSION
        </span>
      </div>

      <!-- Controls -->
      <div class="controls">
        <input type="text" id="searchInput" class="search-input" placeholder="Search tests...">
        <div class="btn-group">
          <button class="btn active" data-filter="all">All</button>
          <button class="btn pass" data-filter="pass">Passed</button>
          <button class="btn warning" data-filter="warning">Warning</button>
          <button class="btn fail" data-filter="fail">Failed</button>
        </div>
        <div class="btn-group">
          <button class="btn sort-btn active" data-sort="name">Name</button>
          <button class="btn sort-btn" data-sort="status">Status</button>
          <button class="btn sort-btn" data-sort="diff">Diff</button>
        </div>
      </div>

      <!-- Test list -->
      <div class="test-list" id="testGrid"></div>
      <div class="no-results" id="noResults">
        <p>No tests match the current filter</p>
      </div>
    </main>
  </div>

  <!-- Overlay for data viewing -->
  <div class="overlay" id="dataOverlay">
    <div class="overlay-content">
      <div class="overlay-header">
        <h2 class="overlay-title" id="overlayTitle">Data</h2>
        <div class="overlay-close" onclick="closeOverlay()">&times;</div>
      </div>
      <div class="overlay-data" id="overlayData"></div>
    </div>
  </div>

  <script>
    // Test data (base64 encoded JSON)
    const testData = JSON.parse(atob("{TEST_DATA_BASE64}"));
    
    // State
    let currentFilter = 'all';
    let currentSort = 'name';
    let currentSearch = '';

    // DOM elements
    const testGrid = document.getElementById('testGrid');
    const noResults = document.getElementById('noResults');

    function initialize() {
      updateSummary();
      renderTests();
      setupEventListeners();
    }

    function updateSummary() {
      const total = testData.length;
      const passed = testData.filter(t => t.passed).length;
      const totalPixels = 800 * 600;
      const warning = testData.filter(t => !t.passed && t.diff_count <= totalPixels * 0.02).length;
      const failed = total - passed - warning;

      document.getElementById('totalTests').textContent = total;
      document.getElementById('passedTests').textContent = passed;
      document.getElementById('failedTests').textContent = failed;
      document.getElementById('warningTests').textContent = warning;
      document.getElementById('passPercentage').textContent = total > 0 ? Math.round(passed / total * 100) : 0;
      document.getElementById('failPercentage').textContent = total > 0 ? Math.round(failed / total * 100) : 0;
      document.getElementById('warnPercentage').textContent = total > 0 ? Math.round(warning / total * 100) : 0;
    }

    function getTestStatus(test) {
      if (test.passed) return 'pass';
      const totalPixels = 800 * 600;
      return test.diff_count <= totalPixels * 0.02 ? 'warning' : 'fail';
    }

    function testMatchesSearch(test, query) {
      if (!query) return true;
      const q = query.toLowerCase();
      if (q.startsWith('status:')) {
        const status = q.substring(7);
        const testStatus = getTestStatus(test);
        if (status === 'passing') return testStatus === 'pass';
        if (status === 'failing') return testStatus === 'fail';
        if (status === 'warning') return testStatus === 'warning';
        return false;
      }
      return test.test_name.toLowerCase().includes(q) ||
             (test.title && test.title.toLowerCase().includes(q));
    }

    function sortTests(tests, sortBy) {
      return [...tests].sort((a, b) => {
        if (sortBy === 'status') {
          const statusOrder = { pass: 0, warning: 1, fail: 2 };
          return statusOrder[getTestStatus(a)] - statusOrder[getTestStatus(b)];
        }
        if (sortBy === 'diff') return b.diff_count - a.diff_count;
        return a.test_name.localeCompare(b.test_name);
      });
    }

    function groupTestsByCategory(tests) {
      const groups = {};
      tests.forEach(test => {
        const parts = test.test_name.split('-');
        const category = parts.length > 2 ? parts[0] : 'other';
        if (!groups[category]) groups[category] = [];
        groups[category].push(test);
      });
      return groups;
    }

    function renderTests() {
      let filtered = testData.filter(t => {
        const matchesFilter = currentFilter === 'all' || getTestStatus(t) === currentFilter;
        const matchesSearch = testMatchesSearch(t, currentSearch);
        return matchesFilter && matchesSearch;
      });

      filtered = sortTests(filtered, currentSort);
      const grouped = groupTestsByCategory(filtered);

      testGrid.innerHTML = '';
      
      if (filtered.length === 0) {
        noResults.style.display = 'block';
        return;
      }
      noResults.style.display = 'none';

      const categories = Object.keys(grouped).sort((a, b) => {
        if (a === 'showcase') return -1;
        if (b === 'showcase') return 1;
        return a.localeCompare(b);
      });

      categories.forEach(cat => {
        const header = document.createElement('div');
        header.className = 'category-header';
        header.textContent = `${cat} (${grouped[cat].length})`;
        testGrid.appendChild(header);

        grouped[cat].forEach(test => {
          testGrid.appendChild(createTestCard(test));
        });
      });
    }

    function createTestCard(test) {
      const status = getTestStatus(test);
      const statusLabel = status.toUpperCase();
      
      const card = document.createElement('div');
      card.className = `test-card ${status} collapsed`;
      card.dataset.name = test.test_name;
      card.dataset.status = status;

      card.innerHTML = `
        <div class="test-header" onclick="toggleCard(this)">
          <div class="test-header-left">
            <span class="collapse-icon">▼</span>
            <h3 class="test-title">${escapeHtml(test.test_name)}</h3>
          </div>
          <div>
            <span class="test-badge ${status}">${statusLabel}</span>
            <span class="diff-count">${test.diff_count.toLocaleString()} px</span>
          </div>
        </div>
        <div class="test-body">
          <div class="test-images">
            <div class="test-img-box">
              <img class="lazy" data-src="./reftest_img/${test.test_name}_chrome.webp" alt="Chrome">
              <div class="test-img-label">Chrome (Reference)</div>
            </div>
            <div class="test-img-box">
              <img class="lazy" data-src="./reftest_img/${test.test_name}_azul.webp" alt="Azul">
              <div class="test-img-label">Azul (Tested)</div>
            </div>
          </div>
          <div class="test-actions">
            <button class="action-btn" onclick="showData('${test.test_name}', 'xhtml')">XHTML</button>
            <button class="action-btn" onclick="showData('${test.test_name}', 'warnings')">CSS Warnings</button>
            <button class="action-btn" onclick="showData('${test.test_name}', 'xml')">Parsed XML</button>
            <button class="action-btn" onclick="showData('${test.test_name}', 'dom')">Styled DOM</button>
            <button class="action-btn" onclick="showData('${test.test_name}', 'layout')">Layout</button>
            <button class="action-btn" onclick="showData('${test.test_name}', 'display')">Display List</button>
            <button class="action-btn" onclick="showData('${test.test_name}', 'chrome_layout')">Chrome Layout</button>
            <button class="action-btn primary" onclick="copyDebugData('${test.test_name}')">Copy All Debug</button>
          </div>
        </div>
      `;
      return card;
    }

    function toggleCard(headerEl) {
      const card = headerEl.closest('.test-card');
      card.classList.toggle('collapsed');
      if (!card.classList.contains('collapsed')) {
        card.querySelectorAll('img.lazy').forEach(img => {
          if (img.dataset.src && !img.src) img.src = img.dataset.src;
        });
      }
    }

    function setupEventListeners() {
      document.getElementById('searchInput').addEventListener('input', e => {
        currentSearch = e.target.value;
        renderTests();
      });

      document.querySelectorAll('.btn[data-filter]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.btn[data-filter]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          renderTests();
        });
      });

      document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentSort = btn.dataset.sort;
          renderTests();
        });
      });
    }

    function showData(testName, type) {
      const test = testData.find(t => t.test_name === testName);
      if (!test) return;

      const titles = {
        xhtml: 'XHTML Source',
        warnings: 'CSS Warnings',
        xml: 'Parsed XML',
        dom: 'Styled DOM',
        layout: 'Solved Layout',
        display: 'Display List',
        chrome_layout: 'Chrome Computed Layout'
      };

      const data = {
        xhtml: test.xhtml_source,
        warnings: test.css_warnings,
        xml: test.parsed_xml,
        dom: test.styled_dom,
        layout: test.solved_layout,
        display: test.display_list,
        chrome_layout: test.chrome_layout || 'Chrome layout data not available.\n\nTo enable, Chrome DevTools Protocol (CDP) must be used during screenshot capture to extract computed styles and layout information.'
      };

      document.getElementById('overlayTitle').textContent = `${titles[type]} - ${testName}`;
      document.getElementById('overlayData').textContent = data[type] || 'Not available';
      document.getElementById('dataOverlay').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeOverlay() {
      document.getElementById('dataOverlay').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    function copyDebugData(testName) {
      const test = testData.find(t => t.test_name === testName);
      if (!test) return;

      const sections = [
        ['XHTML SOURCE', test.xhtml_source],
        ['CSS WARNINGS', test.css_warnings],
        ['PARSED XML', test.parsed_xml],
        ['STYLED DOM', test.styled_dom],
        ['SOLVED LAYOUT', test.solved_layout],
        ['DISPLAY LIST', test.display_list],
        ['RENDER DEBUG', test.render_warnings],
        ['CHROME COMPUTED LAYOUT', test.chrome_layout]
      ];

      const text = sections
        .map(([title, content]) => `=== ${title} ===\n${content || 'Not available'}`)
        .join('\n\n');

      navigator.clipboard.writeText(text)
        .then(() => alert('Debug data copied to clipboard!'))
        .catch(err => {
          console.error('Copy failed:', err);
          alert('Failed to copy. See console.');
        });
    }

    function escapeHtml(s) {
      if (!s) return '';
      return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    document.getElementById('dataOverlay').addEventListener('click', e => {
      if (e.target === document.getElementById('dataOverlay')) closeOverlay();
    });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeOverlay(); });

    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>
